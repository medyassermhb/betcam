<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionnaire de Tâches - Suivi des Dossiers</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        /* Modal transition */
        #taskModal, #importModal, #notificationPanel, #profileModal, #agentModal, #confirmModal, #advancedTaskModal, #eventModal { transition: opacity 0.3s ease-in-out; }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .status-termine { background-color: #dcfce7; color: #166534; }
        .status-inachevee { background-color: #ffedd5; color: #9a3412; }
        .status-afaire { background-color: #e5e7eb; color: #374151; }
                .status-annule { background-color: #fee2e2; color: #991b1b; } /* Add this line */


        /* Simple animation for dashboard cards */
        .stat-card, .dashboard-panel {
             transform: translateY(20px);
             opacity: 0;
             animation: fadeInUp 0.5s ease forwards;
        }
        .stat-card {
            cursor: pointer;
        }
        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        /* Styles for import preview table */
        #importPreviewTable {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }
        #importPreviewTable th, #importPreviewTable td {
            border: 1px solid #e5e7eb;
            padding: 8px;
            text-align: left;
        }
        #importPreviewTable th {
            background-color: #f9fafb;
        }
        #importPreviewTable tr:nth-child(even) {
            background-color: #f9fafb;
        }

        /* Modal Tab Styles */
        .modal-tab {
            padding: 8px 16px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            color: #6b7280;
        }
        .modal-tab.active {
            color: #2563eb;
            border-color: #2563eb;
        }
        
        /* Stepper Styles */
        .stepper {
            display: flex;
            justify-content: space-between;
            position: relative;
            margin-bottom: 24px;
        }
        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            width: 120px;
            position: relative;
            z-index: 1;
        }
        .step-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e5e7eb; /* default */
            border: 3px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #6b7280;
            transition: all 0.3s ease;
        }
        .step.active .step-icon {
            background-color: #3b82f6; /* active */
            border-color: #3b82f6;
            color: white;
        }
        .step.completed .step-icon {
            background-color: #16a34a; /* completed */
            border-color: #16a34a;
            color: white;
        }
        .stepper::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 4px;
            background-color: #e5e7eb;
            z-index: 0;
            transform: translateY(-50%);
        }
        
        /* Kanban/Advanced Task Styles */
        .task-column {
            min-height: 400px; /* Ensure columns have height for dropping */
        }
        .kanban-task {
            cursor: grab;
        }
        .kanban-task.dragging {
            opacity: 0.5;
        }
        
        /* Calendar Styles */
        .calendar-day {
            min-height: 120px;
        }
        .calendar-task {
            font-size: 0.75rem;
            padding: 2px 6px;
            margin-bottom: 2px;
            border-radius: 4px;
            cursor: pointer;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .event-dossier { background-color: #eff6ff; color: #1d4ed8; border-left: 3px solid #3b82f6; }
        .event-task { background-color: #fefce8; color: #854d0e; border-left: 3px solid #eab308; }
        .event-vacation { background-color: #f0fdf4; color: #166534; border-left: 3px solid #22c55e; }
        .event-holiday { background-color: #fef2f2; color: #991b1b; border-left: 3px solid #ef4444; }
        .day-other-month {
            background-color: #f9fafb;
            color: #9ca3af;
        }
        /* Stats Page Styles */
        .stats-tab {
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .stats-tab.active {
            background-color: #3b82f6;
            color: white;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        /* Sidebar Styles */
        .sidebar-nav-link {
             display: flex;
             align-items: center;
             padding: 0.75rem 1rem;
             border-radius: 0.5rem;
             font-weight: 500;
             color: #4b5563;
             transition: background-color 0.2s, color 0.2s;
        }
        .sidebar-nav-link:hover {
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .sidebar-nav-link.active {
            background-color: #e0f2fe;
            color: #0c4a6e;
            font-weight: 600;
        }

    </style>
</head>

<body class="antialiased text-gray-800">

    <div id="loadingSpinner" class="fixed inset-0 bg-white bg-opacity-80 flex items-center justify-center z-[100]">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-600"></div>
    </div>
    
    <div id="generalError" class="hidden fixed top-5 right-5 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg shadow-lg z-[101]" role="alert">
        <strong class="font-bold">Erreur!</strong>
        <span id="generalErrorMessage" class="block sm:inline">Quelque chose s'est mal passé.</span>
    </div>


    <div id="loginPage" class="min-h-screen flex items-center justify-center bg-gray-100">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-2xl shadow-lg">
            <div>
                <h2 class="text-3xl font-extrabold text-center text-gray-900">Connexion</h2>
                <p class="mt-2 text-sm text-center text-gray-600">Accédez à votre tableau de bord</p>
            </div>
            <div id="loginError" class="hidden p-3 text-sm text-red-700 bg-red-100 rounded-lg"></div>
            <form id="loginForm" class="space-y-6">
                <div>
                    <label for="email" class="sr-only">Email</label>
                    <input id="email" name="email" type="email" autocomplete="email" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Adresse e-mail">
                </div>
                <div>
                    <label for="password" class="sr-only">Password</label>
                    <input id="password" name="password" type="password" autocomplete="current-password" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Mot de passe">
                </div>
                <div>
                    <button type="submit" id="loginButton" class="w-full px-4 py-3 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition">
                        Se connecter
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="appContainer" class="hidden">
        <!-- Sidebar -->
        <aside id="sidebar" class="fixed top-0 left-0 z-40 w-64 h-screen bg-white shadow-lg transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out">
            <div class="p-4">
                 <span class="font-bold text-2xl text-gray-800">BETCAM TASK</span>
            </div>
            <nav id="mainNav" class="mt-4 px-2 space-y-2">
                <a href="#" id="navDashboard" class="sidebar-nav-link">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg>
                    Tableau de Bord
                </a>
                <a href="#" id="navDossiers" class="sidebar-nav-link">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" /><path fill-rule="evenodd" d="M4 5a2 2 0 012-2h8a2 2 0 012 2v10a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 011-1h2a1 1 0 110 2H8a1 1 0 01-1-1zm-1 4a1 1 0 100 2h6a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>
                    Liste des Dossiers
                </a>
                <a href="#" id="navAdvancedTasks" class="sidebar-nav-link">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                    Tâches
                </a>
                <a href="#" id="navCalendar" class="sidebar-nav-link">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>
                    Calendrier
                </a>
                <a href="#" id="navProductivity" class="sidebar-nav-link">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12 7a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0V8.414l-4.293 4.293a1 1 0 01-1.414 0L8 11.414l-4.293 4.293a1 1 0 01-1.414-1.414l5-5a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 011.414 0l1 1V7h-1z" clip-rule="evenodd" /></svg>
                    Productivité
                </a>
                <a href="#" id="navStats" class="sidebar-nav-link">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path d="M2 11a1 1 0 011-1h2a1 1 0 110 2H3a1 1 0 01-1-1zm5 0a1 1 0 011-1h2a1 1 0 110 2H8a1 1 0 01-1-1zm5 0a1 1 0 011-1h2a1 1 0 110 2h-2a1 1 0 01-1-1zM2 15a1 1 0 011-1h14a1 1 0 110 2H3a1 1 0 01-1-1zM2 7a1 1 0 011-1h14a1 1 0 110 2H3a1 1 0 01-1-1zM2 3a1 1 0 011-1h14a1 1 0 110 2H3a1 1 0 01-1-1z" /></svg>
                    Statistiques
                </a>
                <a href="#" id="navFacturation" class="sidebar-nav-link">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7zM15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path d="M10 9a1 1 0 100-2 1 1 0 000 2z" />
                    </svg>
                    Facturation
                </a>
                <a href="#" id="navAdmin" class="sidebar-nav-link hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 8a6 6 0 11-12 0 6 6 0 0112 0zM7 8a3 3 0 116 0 3 3 0 01-6 0zm11 5a1 1 0 01-1 1H3a1 1 0 110-2h14a1 1 0 011 1z" clip-rule="evenodd" /></svg>
                    Administration
                </a>
            </nav>
        </aside>

        <!-- Sidebar Overlay for Mobile -->
        <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>

        <div class="md:ml-64 transition-all duration-300 ease-in-out">
            <header class="bg-white shadow-md sticky top-0 z-20">
<div class="container mx-auto px-4 sm:px-6 lg:px-8">
                            <div class="flex items-center justify-between h-16">
                                <div class="flex items-center">
                                    <button id="mobileMenuBtn" class="md:hidden p-2 rounded-md text-gray-500 hover:text-gray-700 hover:bg-gray-100">
                                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                                        </svg>
                                    </button>
                                </div>

                                <div class="hidden sm:flex flex-1 justify-center px-4">
                                    <div class="relative w-full max-w-xs lg:max-w-sm">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                                            </svg>
                                        </div>
                                        <input id="globalSearchInput" type="text" class="block w-full bg-gray-100 border border-transparent rounded-md py-2 pl-10 pr-3 text-sm placeholder-gray-500 focus:outline-none focus:bg-white focus:border-blue-500 focus:ring-blue-500" placeholder="Rechercher un dossier...">
                                    </div>
                                </div>

                                <div class="flex items-center space-x-2 sm:space-x-4">
                                    <div class="relative">
                                        <button id="notificationBtn" class="p-2 rounded-full text-gray-500 hover:text-gray-700 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                            <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                                            </svg>
                                        </button>
                                        <span id="notificationCount" class="hidden absolute -top-1 -right-1 bg-red-600 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center"></span>
                                    </div>
                                    <div class="relative">
                                        <div id="userMenuButton" class="cursor-pointer flex items-center gap-2">
                                            <img id="headerProfilePicture" src="https://placehold.co/40x40" alt="Profile Picture" class="w-8 h-8 rounded-full object-cover">
                                            <div class="hidden sm:block">
                                                <p id="userName" class="text-sm font-semibold text-gray-800"></p>
                                                <p id="userRole" class="text-xs text-gray-500 capitalize"></p>
                                            </div>
                                        </div>
                                        <div id="userDropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50">
                                            <a href="#" id="profileButton" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Mon Profil</a>
                                            <a href="#" id="logoutButton" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Déconnexion</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
            </header>

            <div id="notificationPanel" class="hidden absolute top-16 right-4 mt-2 w-80 bg-white rounded-lg shadow-xl border z-50 opacity-0">
                <div class="p-4 font-bold border-b">Notifications</div>
                <div id="notificationList" class="max-h-96 overflow-y-auto">
                    </div>
            </div>

            <main class="p-4 md:p-6 lg:p-8">
                <div id="dashboardPage">
                    <h1 class="text-3xl font-bold text-gray-900 mb-6">Tableau de Bord Analytique</h1>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div id="statCardTotal" class="stat-card bg-white p-6 rounded-xl shadow-sm border border-gray-200 hover:border-blue-500 transition" style="animation-delay: 0.1s;">
                            <h3 class="text-sm font-medium text-gray-500">Dossiers Totaux</h3>
                            <p id="statTotal" class="text-3xl font-bold text-gray-900 mt-2">0</p>
                        </div>
                        <div id="statCardInitialOverdue" class="stat-card bg-white p-6 rounded-xl shadow-sm border border-gray-200 hover:border-red-500 transition" style="animation-delay: 0.5s;">
                            <h3 class="text-sm font-medium text-gray-500">En Retard (30min)</h3>
                            <p id="statInitialOverdue" class="text-3xl font-bold text-red-600 mt-2">0</p>
                        </div>
                        <div id="statCardCompleted" class="stat-card bg-white p-6 rounded-xl shadow-sm border border-gray-200 hover:border-blue-500 transition" style="animation-delay: 0.2s;">
                            <h3 class="text-sm font-medium text-gray-500">Dossiers Terminés</h3>
                            <p id="statCompleted" class="text-3xl font-bold text-green-600 mt-2">0</p>
                        </div>
                        <div id="statCardInProgress" class="stat-card bg-white p-6 rounded-xl shadow-sm border border-gray-200 hover:border-blue-500 transition" style="animation-delay: 0.3s;">
                            <h3 class="text-sm font-medium text-gray-500">Dossiers en Cours</h3>
                            <p id="statInProgress" class="text-3xl font-bold text-orange-500 mt-2">0</p>
                        </div>
                         <div id="statCardTodo" class="stat-card bg-white p-6 rounded-xl shadow-sm border border-gray-200 hover:border-blue-500 transition" style="animation-delay: 0.4s;">
                            <h3 class="text-sm font-medium text-gray-500">Dossiers à Faire</h3>
                            <p id="statTodo" class="text-3xl font-bold text-gray-600 mt-2">0</p>
                        </div>
                    </div>
    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                        <div id="statCardOverdue" class="stat-card bg-white p-6 rounded-xl shadow-sm border border-red-200 hover:border-red-500 transition" style="animation-delay: 0.5s;">
                                 <h3 class="text-sm font-medium text-gray-500">Dossiers en Retard</h3>
                                 <p id="statOverdue" class="text-3xl font-bold text-red-600 mt-2">0</p>
                        </div>
                        <div id="statCardHighDevis" class="stat-card bg-white p-6 rounded-xl shadow-sm border border-gray-200 hover:border-red-500 transition" style="animation-delay: 0.6s;">
                            <h3 class="text-sm font-medium text-gray-500">Devis > 20k DH</h3>
                            <p id="statHighDevis" class="text-3xl font-bold text-red-600 mt-2">0</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200" style="animation-delay: 0.7s;">
                                 <h3 class="text-sm font-medium text-gray-500">Délai Moyen de Clôture</h3>
                                 <p id="statAvgCompletion" class="text-3xl font-bold text-blue-600 mt-2">N/A</p>
                        </div>
                    </div>
    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="dashboard-panel lg:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-gray-200" style="animation-delay: 0.8s;">
                            <h3 class="text-lg font-semibold mb-4">Performance par Agent</h3>
                            <div id="agentKpiContainer" class="space-y-4 max-h-96 overflow-y-auto pr-2">
                                <!-- Agent KPI cards will be injected here by JavaScript -->
                            </div>
                        </div>
                        <div class="dashboard-panel bg-white p-6 rounded-xl shadow-sm border border-gray-200" style="animation-delay: 0.9s;">
                                 <h3 class="text-lg font-semibold mb-4">Dossiers en Retard</h3>
                                 <div id="overdueTasksList" class="space-y-3 max-h-80 overflow-y-auto">
                                     </div>
                        </div>
                    </div>
                </div>
    
                <div id="productivityPage" class="hidden">
                    <header class="mb-8 flex justify-between items-center">
                        <h1 class="text-3xl font-bold text-gray-900">Analyse de Productivité</h1>
                        <div class="flex items-center gap-2">
                            <label for="productivityDate" class="font-medium">Date:</label>
                            <input type="date" id="productivityDate" class="p-2 border border-gray-300 rounded-lg">
                        </div>
                    </header>
    
                    <div id="productivityContent">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                <h3 class="text-lg font-semibold mb-4 text-center">Dossiers Terminés par Agent (Aujourd'hui)</h3>
                                <canvas id="missionsChart"></canvas>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                <h3 class="text-lg font-semibold mb-4 text-center">Allocation du Temps de Travail (8h)</h3>
                                <canvas id="timeChart"></canvas>
                            </div>
                        </div>
    
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Agent</th>
                                        <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nouveaux (J)</th>
                                        <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Anciens</th>
                                        <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total (J)</th>
                                        <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Temps Alloué (h)</th>
                                        <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Temps Libre Théorique (h)</th>
                                        <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Performance</th>
                                    </tr>
                                </thead>
                                <tbody id="productivityTableBody" class="divide-y divide-gray-200">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
    
                <div id="statsPage" class="hidden">
                    <header class="mb-8 flex flex-col md:flex-row justify-between items-center gap-4">
                         <div>
                            <h1 class="text-3xl font-bold text-gray-900">Statistiques de Performance</h1>
                            <p class="text-gray-600 mt-1">Analyser les tendances et les performances sur différentes périodes.</p>
                        </div>
                        <div class="flex items-center gap-2 bg-gray-200 p-1 rounded-lg">
                            <button id="statsWeeklyBtn" class="stats-tab active">Hebdomadaire</button>
                            <button id="statsMonthlyBtn" class="stats-tab">Mensuel</button>
                            <button id="statsQuarterlyBtn" class="stats-tab">Trimestriel</button>
                        </div>
                    </header>
                    <div id="statsContent">
                         <!-- Stats content will be rendered here by renderStatsPage() -->
                    </div>
                </div>
                
                <div id="calendarPage" class="hidden">
                     <header class="mb-8 flex justify-between items-center">
                         <div>
                            <h1 class="text-3xl font-bold text-gray-900">Calendrier des Échéances</h1>
                            <p class="text-gray-600 mt-1">Vue mensuelle des dossiers, tâches et événements.</p>
                        </div>
                            <div class="flex flex-col sm:flex-row items-center gap-4">
                                <div class="flex-grow">
                                    <select id="calendarAgentFilter" class="w-full sm:w-auto border-gray-300 rounded-lg shadow-sm">
                                        <option value="all">Tous les agents</option>
                                    </select>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button id="prevMonthBtn" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                                    </button>
                                    <h2 id="monthYear" class="text-xl font-semibold w-32 text-center"></h2>
                                    <button id="nextMonthBtn" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                                    </button>
                                </div>
                                 <button id="addEventBtn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-300 flex items-center shadow-sm w-full sm:w-auto justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                                    Ajouter un événement
                                </button>
                            </div>
                    </header>
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                        <div class="grid grid-cols-7 text-center font-bold text-gray-600 border-b">
                            <div class="p-3">Lundi</div>
                            <div class="p-3">Mardi</div>
                            <div class="p-3">Mercredi</div>
                            <div class="p-3">Jeudi</div>
                            <div class="p-3">Vendredi</div>
                            <div class="p-3">Samedi</div>
                            <div class="p-3">Dimanche</div>
                        </div>
                        <div id="calendarGrid" class="grid grid-cols-7">
                        </div>
                    </div>
                </div>
    
                <div id="dossiersPage" class="hidden">
                     <div class="container mx-auto">
                        <header class="mb-8">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h1 class="text-3xl font-bold text-gray-900">Suivi des Dossiers d'Accident</h1>
                                    <p class="text-gray-600 mt-1">Tableau de bord pour le suivi des missions des agents.</p>
                                </div>
                                <div class="flex space-x-2">
                                     <button id="importBtn" class="hidden bg-white text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-100 transition-colors duration-300 flex items-center shadow-sm border border-gray-300">
                                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                             <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                                         </svg>
                                         Importer
                                     </button>
                                     <button id="addTaskBtn" class="hidden bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-300 flex items-center shadow-sm">
                                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                             <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                                         </svg>
                                         Ajouter Dossier
                                     </button>
                                </div>
                            </div>
                        </header>
                        <div class="p-4 bg-white rounded-xl shadow-sm border border-gray-200 mb-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                <div class="lg:col-span-2">
                                     <label for="search" class="sr-only">Rechercher</label>
                                     <input type="text" id="search" placeholder="Rechercher par Réf, Assuré, Matricule, Marque..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                                </div>
                                <div>
                                    <label for="agentFilter" class="sr-only">Filtrer par agent</label>
                                    <select id="agentFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                                        <option value="all">Tous les agents</option>
                                    </select>
                                </div>
                                <div>
                                   <label for="companyFilter" class="sr-only">Filtrer par compagnie</label>
                                    <select id="companyFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                                        <option value="all">Toutes les compagnies</option>
                                    </select>
                                </div>
                                 <div class="lg:col-start-3">
                                   <label for="statusFilter" class="sr-only">Filtrer par statut</label>
                                    <select id="statusFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                                        <option value="all">Tous les statuts</option>
                                        <option value="Terminé">Terminé</option>
                                        <option value="inachevee">En cours</option>
                                        <option value="À faire">À faire</option>
                                        <option value="Annulé">Annulé</option>
                                        <option value="initialOverdue" class="text-red-600 font-medium">En Retard (30min)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <main id="taskGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></main>
                         <div id="noResults" class="hidden text-center py-16">
                            <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <h3 class="mt-2 text-sm font-medium text-gray-900">Aucun dossier trouvé</h3>
                            <p class="mt-1 text-sm text-gray-500">Essayez de modifier vos filtres de recherche.</p>
                        </div>
                    </div>
                </div>
                
<div id="advancedTasksPage" class="hidden">
    <header class="mb-6">
        <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Tâches</h1>
                <p class="text-gray-600 mt-1">Organisez et suivez vos tâches avec le tableau Kanban.</p>
            </div>
            <button id="addAdvancedTaskBtn" class="w-full sm:w-auto bg-blue-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-blue-700 transition-colors duration-300 flex items-center justify-center shadow-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                Ajouter une Tâche
            </button>
        </div>
        <div class="mt-6 p-3 bg-white rounded-xl border border-gray-200 flex flex-col sm:flex-row items-center gap-3">
            <div class="relative w-full sm:w-auto flex-grow">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                </div>
                <input type="text" id="advancedTaskSearch" class="w-full border-gray-300 rounded-lg pl-10" placeholder="Rechercher par titre...">
            </div>
            <select id="advancedTaskAssigneeFilter" class="w-full sm:w-auto border-gray-300 rounded-lg">
                <option value="all">Tous les agents</option>
            </select>
            <select id="advancedTaskPriorityFilter" class="w-full sm:w-auto border-gray-300 rounded-lg">
                <option value="all">Toute priorité</option>
                <option value="Haute">Haute</option>
                <option value="Moyenne">Moyenne</option>
                <option value="Basse">Basse</option>
            </select>
            <div class="w-full sm:w-auto flex items-center gap-2 justify-center">
                <input type="checkbox" id="urgentFilter" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                <label for="urgentFilter" class="text-sm font-medium text-gray-700 whitespace-nowrap">Échéance Proche</label>
            </div>
        </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="bg-gray-50 rounded-xl p-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="font-bold text-lg text-gray-800">À Faire</h2>
                <span id="todo-count" class="text-sm font-semibold text-gray-500 bg-gray-200 px-2 py-1 rounded-full">0</span>
            </div>
            <div id="todo-col" class="task-column space-y-4 min-h-[400px]"></div>
        </div>
        <div class="bg-gray-50 rounded-xl p-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="font-bold text-lg text-gray-800">En Cours</h2>
                <span id="inprogress-count" class="text-sm font-semibold text-gray-500 bg-gray-200 px-2 py-1 rounded-full">0</span>
            </div>
            <div id="inprogress-col" class="task-column space-y-4 min-h-[400px]"></div>
        </div>
        <div class="bg-gray-50 rounded-xl p-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="font-bold text-lg text-gray-800">Terminé</h2>
                <span id="done-count" class="text-sm font-semibold text-gray-500 bg-gray-200 px-2 py-1 rounded-full">0</span>
            </div>
            <div id="done-col" class="task-column space-y-4 min-h-[400px]"></div>
        </div>
    </div>
</div>
        
        
                <div id="adminPage" class="hidden">
                    <div class="container mx-auto">
                        <header class="mb-8 flex justify-between items-center">
                            <div>
                                <h1 class="text-3xl font-bold text-gray-900">Administration des Agents</h1>
                                <p class="text-gray-600 mt-1">Ajouter, modifier ou supprimer des utilisateurs.</p>
                            </div>
                            <button id="addAgentBtn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-300 flex items-center shadow-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                                </svg>
                                Nouvel Agent
                            </button>
                        </header>
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nom</th>
                                        <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                        <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rôle</th>
                                        <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                            <tbody id="agentsTableBody" class="divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="facturationPage" class="hidden">
                 <header class="mb-8">
                    <h1 class="text-3xl font-bold text-gray-900">Suivi de Facturation</h1>
                    <p class="text-gray-600 mt-1">Consultez les dossiers terminés en attente de paiement ou déjà payés.</p>
                </header>

                    <!-- ADD THIS NEW SECTION -->
                    <div class="mb-8">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">Synthèse par Compagnie</h2>
                        <div id="companyStatsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <!-- Company stats will be injected here -->
                        </div>
                    </div>

                    <!-- Stat Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-orange-200">
                            <h3 class="text-sm font-medium text-gray-500">Montant en Attente</h3>
                            <p id="facturationTotalEnAttente" class="text-3xl font-bold text-orange-600 mt-2">0 DH</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-green-200">
                            <h3 class="text-sm font-medium text-gray-500">Payé (Ce Mois)</h3>
                            <p id="facturationTotalPaye" class="text-3xl font-bold text-green-600 mt-2">0 DH</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <h3 class="text-sm font-medium text-gray-500">Nombre de Factures en Attente</h3>
                            <p id="facturationCountEnAttente" class="text-3xl font-bold text-gray-800 mt-2">0</p>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="mb-6 flex items-center gap-2 bg-gray-200 p-1 rounded-lg w-full md:w-auto">
                        <button data-filter="all" class="facturation-tab stats-tab active">Tout</button>
                        <button data-filter="pending" class="facturation-tab stats-tab">En Attente</button>
                        <button data-filter="paid" class="facturation-tab stats-tab">Payé</button>
                    </div>

                    <!-- Dossiers Table -->
                     <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Réf.</th>
                                    <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Assuré</th>
                                    <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Compagnie</th>
                                    <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Frais Expertise</th>
                                    <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Statut Paiement</th>
                                    <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date Paiement</th>
                                    <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                </tr>
                            </thead>
                            <tbody id="facturationTableBody" class="divide-y divide-gray-200">
                                <!-- Rows will be injected here by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
    </div>

    <!-- NEW: Event Modal -->
    <div id="eventModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md transform scale-95 transition-transform duration-300">
            <div class="flex justify-between items-center p-5 border-b border-gray-200">
                <h2 id="eventModalTitle" class="text-xl font-bold text-gray-900">Ajouter un événement</h2>
                <button id="closeEventModal" class="text-gray-400 hover:text-gray-600 transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <form id="eventForm" class="p-6 space-y-4">
                <input type="hidden" id="eventId">
                <div>
                    <label for="eventTitle" class="block text-sm font-medium text-gray-700">Titre</label>
                    <input type="text" id="eventTitle" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                </div>
                 <div>
                    <label for="eventUser" class="block text-sm font-medium text-gray-700">Assigné à (pour les vacances)</label>
                    <select id="eventUser" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                       <option value="all">Tous (Férié)</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="eventStartDate" class="block text-sm font-medium text-gray-700">Date de début</label>
                        <input type="date" id="eventStartDate" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                    </div>
                    <div>
                        <label for="eventEndDate" class="block text-sm font-medium text-gray-700">Date de fin</label>
                        <input type="date" id="eventEndDate" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                    </div>
                </div>
                <div>
                    <label for="eventType" class="block text-sm font-medium text-gray-700">Type d'événement</label>
                    <select id="eventType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                        <option value="Vacances">Vacances</option>
                        <option value="Férié">Jour Férié</option>
                    </select>
                </div>
                <div class="flex justify-between items-center pt-4 border-t border-gray-200">
                    <button type="button" id="deleteEventBtn" class="text-red-600 hover:text-red-800 font-medium hidden">Supprimer</button>
                    <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>


    <div id="taskModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div id="modalContent" class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col transform scale-95 transition-transform duration-300">
               <div class="flex justify-between items-center p-5 border-b border-gray-200">
                <div>
                    <h2 id="modalTitle" class="text-xl font-bold text-gray-900">Détails du Dossier</h2>
                    <p id="modalSubtitle" class="text-sm text-gray-500"></p>
                </div>
                <button id="closeModal" class="text-gray-400 hover:text-gray-600 transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <div class="border-b border-gray-200">
                <nav class="flex space-x-4 px-5 -mb-px" aria-label="Tabs">
                    <button id="tabDetails" class="modal-tab active">Détails</button>
                    <button id="tabActivity" class="modal-tab">Activité</button>
                    <button id="tabFiles" class="modal-tab">Fichiers</button>
                    <button id="tabComm" class="modal-tab">Communications</button> <!-- Add this -->

                </nav>
            </div>

            <div class="flex-1 overflow-y-auto">
                <div id="detailsContent" class="p-6">
                    
                    <div id="modalStepper" class="stepper">
                        <div class="step" id="step-1">
                            <div class="step-icon">1</div>
                            <div class="step-label">Documents & Devis</div>
                        </div>
                        <div class="step" id="step-2">
                            <div class="step-icon">2</div>
                            <div class="step-label">Réparation</div>
                        </div>
                        <div class="step" id="step-3">
                            <div class="step-icon">3</div>
                            <div class="step-label">Terminé</div>
                        </div>
                    </div>

                    <div id="modalDisplayGrid" class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6 text-sm">
                        <div class="bg-gray-50 p-3 rounded-lg"><p class="font-semibold text-gray-500">Date Réception</p><p id="modalDateReception" class="text-gray-800"></p></div>
                        <div class="bg-gray-50 p-3 rounded-lg"><p class="font-semibold text-gray-500">Agent Actuel</p><p id="modalAgent" class="text-gray-800"></p></div>
                        <div class="bg-gray-50 p-3 rounded-lg"><p class="font-semibold text-gray-500">Matricule</p><p id="modalMatricule" class="text-gray-800"></p></div>
                        <div class="bg-gray-50 p-3 rounded-lg"><p class="font-semibold text-gray-500">Compagnie</p><p id="modalCompagnie" class="text-gray-800"></p></div>
                        <div class="bg-gray-50 p-3 rounded-lg"><p class="font-semibold text-gray-500">Date Sinistre</p><p id="modalDateSinistre" class="text-gray-800"></p></div>
                        <div class="bg-gray-50 p-3 rounded-lg"><p class="font-semibold text-gray-500">Marque/Modèle</p><p id="modalMarqueModele" class="text-gray-800"></p></div>
                        <div class="bg-gray-50 p-3 rounded-lg md:col-span-3"><p class="font-semibold text-gray-500">Nature Dossier</p><p id="modalNatureDossier" class="text-gray-800"></p></div>
                        <div class="bg-gray-50 p-3 rounded-lg"><p class="font-semibold text-gray-500">Tél. Assuré</p><p id="modalTelephoneAssure" class="text-gray-800"></p></div>
                        <div class="bg-gray-50 p-3 rounded-lg"><p class="font-semibold text-gray-500">Agent Assurance</p><p id="modalNomAgentAssurance" class="text-gray-800"></p></div>
                        <div class="bg-gray-50 p-3 rounded-lg"><p class="font-semibold text-gray-500">Tél. Agent Assurance</p><p id="modalTelephoneAgentAssurance" class="text-gray-800"></p></div>
                    </div>
                    <div id="modalInputGrid" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 text-sm">
                        <input id="modalRefInput" required class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Référence *">
                        <input id="modalAssureInput" required class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Assuré *">
                        <input id="modalMatriculeInput" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Matricule">
                        <input id="modalCompagnieInput" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Compagnie">
                        <input id="modalMarqueModeleInput" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Marque & Modèle">
                        <input id="modalNatureDossierInput" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Nature De Dossier">
                        <input id="modalTelephoneAssureInput" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Téléphone Assuré">
                        <input id="modalNomAgentAssuranceInput" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Nom Agent Assurance">
                        <input id="modalTelephoneAgentAssuranceInput" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Téléphone Agent Assurance">
                        <div class="flex flex-col">
                        <label for="modalDateSinistreInput" class="text-xs font-medium text-gray-600 mb-1">Date Sinistre</label>
                        <input id="modalDateSinistreInput" type="date" class="w-full p-2 border border-gray-300 rounded-lg">
                        </div>
                    </div>
                    
                    <div id="agentAssignmentSection" class="hidden mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <label for="modalAgentAssign" class="block text-sm font-bold text-blue-800 mb-2">Assigner à un Agent</label>
                        <select id="modalAgentAssign" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></select>
                    </div>

                    <div class="mb-6">
                        <h3 id="step1Header" class="font-bold text-gray-800 mb-3">Étape 1: Documents & Devis</h3>
                        <div id="modalChecklist" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-x-6 gap-y-3"></div>
                    </div>

                    <div class="mb-6 border-t pt-6">
                        <h3 id="step2Header" class="font-bold text-gray-800 mb-3">Étape 2: Réparation & Clôture</h3>
                        <div class="space-y-4">
                            <div id="step2Checklist">
                                </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 pt-4 border-t">
                                <div>
                                    <label for="modalMontantDevis" class="block text-sm font-medium text-gray-700">Montant Devis</label>
                                    <input type="number" id="modalMontantDevis" class="mt-1 block w-full ...">
                                </div>
                                <div>
                                    <label for="modalDevisRectifie" class="block text-sm font-medium text-gray-700">Devis Réctifié</label>
                                    <input type="number" id="modalDevisRectifie" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                                </div>
                                <div>
                                    <label for="modalMontantFacture" class="block text-sm font-medium text-gray-700">Montant Facture</label>
                                    <input type="number" id="modalMontantFacture" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                                </div>
                                <div class="flex flex-col">
                                    <label for="modalPhotoDate" class="block text-sm font-medium text-gray-700 mb-1">Date Photos (après réparation)</label>
                                    <input id="modalPhotoDate" type="date" class="w-full p-2 border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label for="modalFactureStatut" class="block text-sm font-medium text-gray-700 mb-1">Statut Facture</label>
                                    <select id="modalFactureStatut" class="w-full p-2 border border-gray-300 rounded-lg">
                                        <option value="">Non défini</option>
                                        <option value="Reçue">Reçue</option>
                                        <option value="En attente">En attente</option>
                                        <option value="Validée">Validée</option>
                                    </select>
                                </div>
                                <div class="flex flex-col">
                                    <label for="modalFactureDate" class="block text-sm font-medium text-gray-700 mb-1">Date Facture</label>
                                    <input id="modalFactureDate" type="date" class="w-full p-2 border border-gray-300 rounded-lg">
                                </div>
                                <div id="reportSentSection" class="hidden mt-4 pt-4 border-t">
                                <div class="flex items-center bg-green-50 p-3 rounded-lg">
                                    <input id="modalReportSent" type="checkbox" class="h-5 w-5 rounded border-gray-300 text-green-600 focus:ring-green-500">
                                    <label for="modalReportSent" class="ml-3 block text-sm font-semibold text-green-800">Rapport final envoyé à la compagnie</label>
                                    <span id="reportSentDate" class="ml-2 text-xs text-gray-500"></span>
                                </div>
                                <div>
                                    <label for="modalFraisExpertise" class="block text-sm font-bold text-blue-700">Frais Expertise (Notre Facturation)</label>
                                    <input type="number" id="modalFraisExpertise" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                                </div>
                            </div>
                            </div>
                        </div>
                    </div>
                    
                         <div class="mb-6">
                        <label for="modalNotes" class="block text-sm font-medium text-gray-700">Notes / Commentaires</label>
                        <textarea id="modalNotes" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2"></textarea>
                    </div>
                </div>

                <div id="activityContent" class="hidden p-6">
                    <div class="border-b pb-4 mb-4">
                           <textarea id="commentInput" rows="3" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" placeholder="Ajouter un commentaire..."></textarea>
                           <div class="flex justify-end mt-2">
                                <button id="addCommentBtn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors duration-300">Ajouter</button>
                           </div>
                    </div>
                    <div id="activityLog" class="space-y-4">
                       </div>
                </div>

                <div id="filesContent" class="hidden p-6">
                    <div class="mb-4">
                        <label for="fileUploadInput" class="block text-sm font-medium text-gray-700 mb-2">Ajouter des fichiers (PDF, Images)</label>
                        <input type="file" id="fileUploadInput" multiple accept=".pdf,.jpg,.jpeg,.png" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                    </div>
                    <div id="fileList" class="space-y-2">
                        </div>
                    </div>
                    <!-- ADD THIS NEW DIV FOR THE COMMUNICATION LOG -->
                    <div id="commContent" class="hidden p-6 space-y-6">
                        <div>
                            <h4 class="font-bold text-lg mb-2">Contacter l'Assuré</h4>
                            <div class="flex items-center space-x-2" id="clientContactActions">
                                <!-- Buttons will be generated here -->
                            </div>
                            <div class="mt-2 text-xs text-gray-500 space-y-1" id="clientCommLog">
                                <!-- Log entries will be generated here -->
                            </div>
                        </div>
                        <div class="border-t pt-6">
                            <h4 class="font-bold text-lg mb-2">Contacter l'Agent d'Assurance</h4>
                            <div class="flex items-center space-x-2" id="agentContactActions">
                                <!-- Buttons will be generated here -->
                            </div>
                            <div class="mt-2 text-xs text-gray-500 space-y-1" id="agentCommLog">
                                <!-- Log entries will be generated here -->
                            </div>
                        </div>
                    </div>
            </div>

            <div id="detailsFooter" class="flex justify-end items-center p-5 border-t border-gray-200 bg-gray-50 rounded-b-2xl">
                                                <button id="cancelDossierBtn" class="bg-red-100 text-red-700 font-bold py-2 px-6 rounded-lg hover:bg-red-200 transition-colors duration-300">Annuler le Dossier</button>
                <button id="saveChanges" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors duration-300">Enregistrer les modifications</button>
            </div>
        </div>
    </div>

    <div id="importModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col transform scale-95 transition-transform duration-300">
            <div class="flex justify-between items-center p-5 border-b border-gray-200">
                <h2 class="text-xl font-bold text-gray-900">Importer des Dossiers</h2>
                <button id="closeImportModal" class="text-gray-400 hover:text-gray-600 transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="p-6 overflow-y-auto">
                <div class="mb-4">
                    <label for="importFile" class="block text-sm font-medium text-gray-700 mb-2">Choisir un fichier Excel (.xlsx, .xls)</label>
                    <input type="file" id="importFile" accept=".xlsx, .xls" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                </div>
                <div id="importPreview" class="mt-4 border rounded-lg p-2 bg-gray-50 overflow-auto max-h-96">
                    <p class="text-center text-gray-500">L'aperçu des données du fichier apparaîtra ici.</p>
                </div>
            </div>
            <div class="flex justify-between items-center p-5 border-t border-gray-200 bg-gray-50 rounded-b-2xl">
                <p id="importStatus" class="text-sm text-gray-600"></p>
                <button id="importConfirmBtn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors duration-300 disabled:bg-gray-400" disabled>Importer la Sélection</button>
            </div>
        </div>
    </div>

    <div id="profileModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md transform scale-95 transition-transform duration-300">
            <div class="flex justify-between items-center p-5 border-b border-gray-200">
                <h2 class="text-xl font-bold text-gray-900">Modifier mon Profil</h2>
                <button id="closeProfileModal" class="text-gray-400 hover:text-gray-600 transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <form id="profileForm" class="p-6 space-y-4">
                <div class="flex flex-col items-center">
                    <img id="profilePicturePreview" src="https://placehold.co/100x100" alt="Profile Preview" class="w-24 h-24 rounded-full object-cover mb-2">
                    <input type="file" id="profilePictureInput" class="hidden" accept="image/*">
                    <button type="button" id="changePictureBtn" class="text-sm text-blue-600 hover:underline">Changer la photo</button>
                </div>
                <div>
                    <label for="profileName" class="block text-sm font-medium text-gray-700">Nom</label>
                    <input type="text" id="profileName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                </div>
                <div>
                    <label for="profileEmail" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="profileEmail" disabled class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-100">
                </div>
                <div>
                    <label for="profilePassword" class="block text-sm font-medium text-gray-700">Nouveau mot de passe (laisser vide pour ne pas changer)</label>
                    <input type="password" id="profilePassword" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                </div>
                <div class="flex justify-end items-center pt-4 border-t border-gray-200">
                    <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <div id="agentModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md transform scale-95 transition-transform duration-300">
            <div class="flex justify-between items-center p-5 border-b border-gray-200">
                <h2 id="agentModalTitle" class="text-xl font-bold text-gray-900">Nouvel Agent</h2>
                <button id="closeAgentModal" class="text-gray-400 hover:text-gray-600 transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <form id="agentForm" class="p-6 space-y-4">
                <input type="hidden" id="agentOriginalEmail">
                <div>
                    <label for="agentName" class="block text-sm font-medium text-gray-700">Nom</label>
                    <input type="text" id="agentName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                </div>
                <div>
                    <label for="agentEmail" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="agentEmail" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                </div>
                <div>
                    <label for="agentPassword" class="block text-sm font-medium text-gray-700">Mot de passe</label>
                    <input type="password" id="agentPassword" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                </div>
                <div>
                      <label for="agentRole" class="block text-sm font-medium text-gray-700">Rôle</label>
                      <select id="agentRole" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                            <option value="employee">Employé(e)</option>
                            <option value="assigner">Superviseur</option>
                            <option value="admin">Admin</option>
                      </select>
                </div>
                <div class="flex justify-end items-center pt-4 border-t border-gray-200">
                    <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

        <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-[60] hidden opacity-0">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md transform scale-95 transition-transform duration-300">
            <div class="p-5 border-b border-gray-200">
                <h2 class="text-xl font-bold text-gray-900">Confirmer l'Annulation</h2>
            </div>
            <div class="p-6 space-y-4">
                <p>Veuillez indiquer la raison de l'annulation de ce dossier. Cette action est irréversible.</p>
                <div>
                    <label for="cancelReason" class="block text-sm font-medium text-gray-700">Raison</label>
                    <textarea id="cancelReason" required rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"></textarea>
                </div>
            </div>
            <div class="flex justify-between items-center p-5 border-t border-gray-200 bg-gray-50 rounded-b-2xl">
                <button id="closeConfirmModal" class="bg-white text-gray-700 font-bold py-2 px-6 rounded-lg hover:bg-gray-100 border border-gray-300">Retour</button>
                <button id="confirmCancelBtn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700">Confirmer l'Annulation</button>
            </div>
        </div>
    </div>
    
    <div id="advancedTaskModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden opacity-0">
            <div id="advancedTaskModalContent" class="bg-white rounded-2xl shadow-2xl w-full max-w-lg transform scale-95 transition-transform duration-300">               <div class="flex justify-between items-center p-5 border-b border-gray-200">
                <h2 id="advancedTaskModalTitle" class="text-xl font-bold text-gray-900">Nouvelle Tâche</h2>
                <button id="closeAdvancedTaskModal" class="text-gray-400 hover:text-gray-600 transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <form id="advancedTaskForm" class="p-6 space-y-4">
                <input type="hidden" id="advancedTaskId">
                <div>
                    <label for="taskTitle" class="block text-sm font-medium text-gray-700">Titre</label>
                    <input type="text" id="taskTitle" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                </div>
                <div>
                    <label for="taskDescription" class="block text-sm font-medium text-gray-700">Description</label>
                    <textarea id="taskDescription" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="taskAssignee" class="block text-sm font-medium text-gray-700">Assigné à</label>
                        <select id="taskAssignee" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"></select>
                    </div>
                    <div>
                        <label for="taskDeadline" class="block text-sm font-medium text-gray-700">Échéance</label>
                        <input type="datetime-local" id="taskDeadline" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="taskPriority" class="block text-sm font-medium text-gray-700">Priorité</label>
                        <select id="taskPriority" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                            <option value="Basse">Basse</option>
                            <option value="Moyenne">Moyenne</option>
                            <option value="Haute">Haute</option>
                        </select>
                    </div>
                    <div>
                        <label for="taskStatus" class="block text-sm font-medium text-gray-700">Statut</label>
                        <select id="taskStatus" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                            <option value="À Faire">À Faire</option>
                            <option value="En Cours">En Cours</option>
                            <option value="Terminé">Terminé</option>
                        </select>
                    </div>
                </div>

                <div class="border-t pt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Sous-tâches</label>
                    <div id="subtaskList" class="space-y-2 max-h-40 overflow-y-auto">
                        </div>
                    <div class="flex items-center gap-2 mt-2">
                        <input type="text" id="newSubtaskInput" class="flex-grow rounded-md border-gray-300 shadow-sm p-2 text-sm" placeholder="Ajouter une sous-tâche...">
                        <button type="button" id="addSubtaskBtn" class="bg-gray-200 text-gray-800 font-bold p-2 rounded-lg hover:bg-gray-300">Ajouter</button>
                    </div>
                </div>
                <div class="flex justify-between items-center pt-4 border-t border-gray-200">
                    <button type="button" id="deleteAdvancedTaskBtn" class="text-red-600 hover:text-red-800 font-medium hidden">Supprimer</button>
                    <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>
    
    <script type="module">
// --- CONFIGURATION ---
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwHXLAUvifOx1gCsD0VSmTajEFywPuX5MHVpBokuMUBscQ5p9-9QQ7OUUBXMY-jg_mQ/exec';
const MISSION_DURATION_MIN = 30; // Temps estimé par mission en minutes
const WORK_DAY_HOURS = 8; // Heures de travail par jour


// --- GLOBAL STATE ---
let agents = [];
let allTasksData = [];
let tasksData = [];
let currentUser = null;
let currentTaskId = null;
let notifications = [];
let notificationInterval = null;
let advancedTasks = [];
let calendarDate = new Date();
let productivityCharts = {};
let calendarEvents = [];
let statsChart = null;


// --- DOM ELEMENTS ---
const loadingSpinner = document.getElementById('loadingSpinner');
const loginPage = document.getElementById('loginPage');
const appContainer = document.getElementById('appContainer');
const dashboardPage = document.getElementById('dashboardPage');
const dossiersPage = document.getElementById('dossiersPage');
const advancedTasksPage = document.getElementById('advancedTasksPage');
const productivityPage = document.getElementById('productivityPage');
const adminPage = document.getElementById('adminPage');
const calendarPage = document.getElementById('calendarPage');
const statsPage = document.getElementById('statsPage'); // NEW
const taskGrid = document.getElementById('taskGrid');
const facturationPage = document.getElementById('facturationPage');
const agentFilter = document.getElementById('agentFilter');
const companyFilter = document.getElementById('companyFilter');
const statusFilter = document.getElementById('statusFilter');
const searchInput = document.getElementById('search');
const noResultsDiv = document.getElementById('noResults');
const modal = document.getElementById('taskModal');
const modalContent = document.getElementById('modalContent');
const closeModalBtn = document.getElementById('closeModal');
const saveChangesBtn = document.getElementById('saveChanges');
const loginForm = document.getElementById('loginForm');
const loginButton = document.getElementById('loginButton');
const loginError = document.getElementById('loginError');
const userMenuButton = document.getElementById('userMenuButton');
const userDropdown = document.getElementById('userDropdown');
const logoutButton = document.getElementById('logoutButton');
const profileButton = document.getElementById('profileButton');
const generalErrorDiv = document.getElementById('generalError');
const generalErrorMessage = document.getElementById('generalErrorMessage');
const globalSearchInput = document.getElementById('globalSearchInput');

// MODIFIED: Added sidebar and mobile menu buttons
const sidebar = document.getElementById('sidebar');
const sidebarOverlay = document.getElementById('sidebarOverlay');
const mobileMenuBtn = document.getElementById('mobileMenuBtn');
const mainNav = document.getElementById('mainNav');

const agentAssignmentSection = document.getElementById('agentAssignmentSection');
const modalAgentAssign = document.getElementById('modalAgentAssign');
const addTaskBtn = document.getElementById('addTaskBtn');
const modalDisplayGrid = document.getElementById('modalDisplayGrid');
const modalInputGrid = document.getElementById('modalInputGrid');
const importBtn = document.getElementById('importBtn');
const importModal = document.getElementById('importModal');
const closeImportModalBtn = document.getElementById('closeImportModal');
const importFile = document.getElementById('importFile');
const importPreview = document.getElementById('importPreview');
const importConfirmBtn = document.getElementById('importConfirmBtn');
const importStatus = document.getElementById('importStatus');
const notificationBtn = document.getElementById('notificationBtn');
const notificationCount = document.getElementById('notificationCount');
const notificationPanel = document.getElementById('notificationPanel');
const notificationList = document.getElementById('notificationList');
const tabDetails = document.getElementById('tabDetails');
const tabActivity = document.getElementById('tabActivity');
// ... near the top of the script
const tabFiles = document.getElementById('tabFiles');
const tabComm = document.getElementById('tabComm'); // Add this
const detailsContent = document.getElementById('detailsContent');
const activityContent = document.getElementById('activityContent');
const filesContent = document.getElementById('filesContent');
const commContent = document.getElementById('commContent'); // Add this
const addCommentBtn = document.getElementById('addCommentBtn');
const fileUploadInput = document.getElementById('fileUploadInput');
const fileList = document.getElementById('fileList');
const detailsFooter = document.getElementById('detailsFooter');
const overdueTasksList = document.getElementById('overdueTasksList');
const profileModal = document.getElementById('profileModal');
const closeProfileModalBtn = document.getElementById('closeProfileModal');
const profileForm = document.getElementById('profileForm');
const agentModal = document.getElementById('agentModal');
const closeAgentModalBtn = document.getElementById('closeAgentModal');
const agentForm = document.getElementById('agentForm');
const advancedTaskModalContent = document.getElementById('advancedTaskModalContent');
const addAgentBtn = document.getElementById('addAgentBtn');
const agentsTableBody = document.getElementById('agentsTableBody');
const changePictureBtn = document.getElementById('changePictureBtn');
const profilePictureInput = document.getElementById('profilePictureInput');

// Add these back - this is the fix
const addAdvancedTaskBtn = document.getElementById('addAdvancedTaskBtn');
const advancedTaskModal = document.getElementById('advancedTaskModal');
const closeAdvancedTaskModalBtn = document.getElementById('closeAdvancedTaskModal'); // The variable for the button
const advancedTaskForm = document.getElementById('advancedTaskForm');
const deleteAdvancedTaskBtn = document.getElementById('deleteAdvancedTaskBtn');

// New variables for redesigned Tâches page
const advancedTaskSearch = document.getElementById('advancedTaskSearch');
const advancedTaskPriorityFilter = document.getElementById('advancedTaskPriorityFilter');
const todoCount = document.getElementById('todo-count');
const inprogressCount = document.getElementById('inprogress-count');
const doneCount = document.getElementById('done-count');

const statCardHighDevis = document.getElementById('statCardHighDevis');
const statHighDevis = document.getElementById('statHighDevis');

const productivityDateInput = document.getElementById('productivityDate');
const productivityTableBody = document.getElementById('productivityTableBody');

const calendarGrid = document.getElementById('calendarGrid');
const monthYearEl = document.getElementById('monthYear');
const prevMonthBtn = document.getElementById('prevMonthBtn');
const nextMonthBtn = document.getElementById('nextMonthBtn');
const addEventBtn = document.getElementById('addEventBtn');
const eventModal = document.getElementById('eventModal');
const closeEventModalBtn = document.getElementById('closeEventModal');
const eventForm = document.getElementById('eventForm');
const deleteEventBtn = document.getElementById('deleteEventBtn');
const calendarAgentFilter = document.getElementById('calendarAgentFilter');
const confirmModal = document.getElementById('confirmModal');
const cancelDossierBtn = document.getElementById('cancelDossierBtn');
const closeConfirmModal = document.getElementById('closeConfirmModal');
const confirmCancelBtn = document.getElementById('confirmCancelBtn');
const cancelReason = document.getElementById('cancelReason');


// NEW: Stats page elements
const statsWeeklyBtn = document.getElementById('statsWeeklyBtn');
const statsMonthlyBtn = document.getElementById('statsMonthlyBtn');
const statsQuarterlyBtn = document.getElementById('statsQuarterlyBtn');
const statsContent = document.getElementById('statsContent');

// --- HELPER FUNCTIONS ---
function normalizeString(str) {
    if (!str) return '';
    return String(str).normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
}

function normalizeHeader(header) {
    if (!header) return '';
    return String(header).toLowerCase()
        .replace(/[éèê]/g, 'e')
        .replace(/\s+/g, '')
        .replace(/&/g, '')
        .replace(/[^\w]/g, '');
}

function getCleanedStatus(status) {
    if (!status) return '';
    return status.replace(/[^\p{L}\s]/gu, '').trim();
}

function formatDateTime(isoString) {
    if (!isoString) return '';
    const date = new Date(isoString);
    if (isNaN(date)) return '';
    return date.toLocaleString('fr-FR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

async function keepAlive() {
    try {
        if (APPS_SCRIPT_URL && APPS_SCRIPT_URL !== 'YOUR_DEPLOYED_WEB_APP_URL_HERE') {
            const response = await fetch(`${APPS_SCRIPT_URL}?action=ping`);
            if (response.ok) {
                console.log('Apps Script is awake.');
            }
        }
    } catch (e) {
        console.warn('Failed to ping Apps Script.', e);
    }
}
setInterval(keepAlive, 300000);

// --- NEW: Global Timer Function ---
function updateAllTimers() {
    const timerElements = document.querySelectorAll('.countdown-timer');
    timerElements.forEach(timerEl => {
        const receptionDate = new Date(timerEl.dataset.receptionDate);
        if (isNaN(receptionDate)) return;

        const thirtyMinutesInMillis = 30 * 60 * 1000;
        const endTime = receptionDate.getTime() + thirtyMinutesInMillis;
        const now = new Date().getTime();
        const timeLeft = endTime - now;

        if (timeLeft > 0) {
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
            timerEl.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" /></svg>
                <span>${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}</span>
            `;
            timerEl.classList.remove('text-red-600', 'bg-red-100');
            timerEl.classList.add('text-orange-600', 'bg-orange-100');
        } else {
            timerEl.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" /></svg>
                <span>Temps écoulé</span>
            `;
            timerEl.classList.remove('text-orange-600', 'bg-orange-100');
            timerEl.classList.add('text-red-600', 'bg-red-100');
        }
    });
}


// --- PAGE NAVIGATION ---
function showPage(pageId) {
    const pages = [dashboardPage, dossiersPage, advancedTasksPage, adminPage, productivityPage, calendarPage, statsPage, facturationPage];
    pages.forEach(p => p.classList.add('hidden'));

    document.getElementById(pageId).classList.remove('hidden');

    if (pageId === 'advancedTasksPage') fetchAdvancedTasks();
    if (pageId === 'dossiersPage') filterAndRender();
    if (pageId === 'productivityPage') renderProductivityPage();
    if (pageId === 'calendarPage') {
            populateCalendarAgentFilter();
            renderCalendar(calendarDate.getFullYear(), calendarDate.getMonth());
        }
    if (pageId === 'statsPage') renderStatsPage('weekly');
    if (pageId === 'statsPage') renderStatsPage('weekly');
    if (pageId === 'facturationPage') renderFacturationPage(); // Add this line


    updateNavStyles(pageId);
}

function updateNavStyles(activePageId) {
    const navLinks = document.querySelectorAll('.sidebar-nav-link');
    navLinks.forEach(link => link.classList.remove('active'));

    const linkIdMap = {
        dashboardPage: 'navDashboard',
        dossiersPage: 'navDossiers',
        advancedTasksPage: 'navAdvancedTasks',
        calendarPage: 'navCalendar',
        productivityPage: 'navProductivity',
        statsPage: 'navStats',
        facturationPage: 'navFacturation', // Add this line
        adminPage: 'navAdmin'
    };

    const activeLinkId = linkIdMap[activePageId];
    if (activeLinkId) {
        const activeLink = document.getElementById(activeLinkId);
        if (activeLink) {
            activeLink.classList.add('active');
        }
    }
}

// --- DATA HANDLING (GOOGLE SHEETS) ---
async function fetchAgents() {
    if (APPS_SCRIPT_URL === 'YOUR_DEPLOYED_WEB_APP_URL_HERE') {
        showError("L'URL de l'application Web n'est pas configurée.");
        return false;
    }
    try {
        const response = await fetch(`${APPS_SCRIPT_URL}?action=getAgents`);
        if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
        const data = await response.json();
        if (data.error) throw new Error(data.error);
        agents = data;
        return true;
    } catch (error) {
        console.error("Error fetching agents:", error);
        showError("Impossible de charger la liste des agents.");
        return false;
    }
}

async function fetchTasks() {
    try {
        const response = await fetch(`${APPS_SCRIPT_URL}?action=getTasks`);
        if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
        const data = await response.json();
        if (data.error) throw new Error(data.error);
        allTasksData = data;
    } catch (error) {
        console.error("Error fetching tasks:", error);
        showError("Impossible de charger les données des dossiers.");
    }
}

async function fetchCalendarEvents() {
    try {
        const response = await fetch(`${APPS_SCRIPT_URL}?action=getCalendarEvents`);
        const data = await response.json();
        if (data.error) throw new Error(data.error);
        calendarEvents = data;
    } catch (error) {
        console.error("Error fetching calendar events:", error);
        showError("Impossible de charger les événements du calendrier.");
    }
}

function filterDataForView() {
    if (!currentUser) {
        tasksData = [];
        return;
    }

    if (currentUser.role.toLowerCase() === 'admin' || currentUser.role.toLowerCase() === 'assigner') {
        tasksData = [...allTasksData];
        agentFilter.disabled = false;
    } else {
        tasksData = allTasksData.filter(task =>
            task.agent && currentUser.name &&
            task.agent.trim().toLowerCase() === currentUser.name.trim().toLowerCase()
        );
        agentFilter.value = currentUser.name;
        agentFilter.disabled = true;
    }
}

async function saveChanges() {
    let taskDataPayload;

    if (currentTaskId === null) {
        const ref = document.getElementById('modalRefInput').value.trim();
        const assure = document.getElementById('modalAssureInput').value.trim();
        if (!ref || !assure) {
            showError("La Référence et l'Assuré sont des champs obligatoires.");
            return;
        }
        if (allTasksData.some(task => String(task.ref).trim() === ref)) {
            showError(`Un dossier avec la référence "${ref}" existe déjà.`);
            return;
        }

        taskDataPayload = {
            action: 'addOrUpdate',
            id: ref,
            ref: ref,
            assure: assure,
            matricule: document.getElementById('modalMatriculeInput').value,
            compagnie: document.getElementById('modalCompagnieInput').value,
            dateSinistre: document.getElementById('modalDateSinistreInput').value || null,
            agent: modalAgentAssign.value,
            marqueModele: document.getElementById('modalMarqueModeleInput').value,
            natureDossier: document.getElementById('modalNatureDossierInput').value,
            dateReception: new Date().toISOString(),
        };

    } else {
        const taskIndex = allTasksData.findIndex(t => String(t.id).trim() == String(currentTaskId).trim());
        if (taskIndex === -1) return;
        taskDataPayload = { ...allTasksData[taskIndex]
        };
        taskDataPayload.action = 'addOrUpdate';

        if (currentUser.role.toLowerCase() === 'admin' || currentUser.role.toLowerCase() === 'assigner') {
            taskDataPayload.agent = modalAgentAssign.value;
        }
    }

    loadingSpinner.classList.remove('hidden');

    taskDataPayload.userEmail = currentUser.email;
    taskDataPayload.userName = currentUser.name;

    const montantDevisInput = document.getElementById('modalMontantDevis');
    const devisRectifieInput = document.getElementById('modalDevisRectifie');
    const montantFactureInput = document.getElementById('modalMontantFacture');
    const forfaitInput = document.getElementById('modalMontantForfait');
    const devisStatusSelect = document.getElementById('devisStatusSelect');

    taskDataPayload.montantDevis = montantDevisInput ? parseFloat(montantDevisInput.value) || 0 : 0;
    taskDataPayload.devisRectifie = devisRectifieInput ? parseFloat(devisRectifieInput.value) || 0 : 0;
    taskDataPayload.montantFacture = montantFactureInput ? parseFloat(montantFactureInput.value) || 0 : 0;
    taskDataPayload.fraisExpertise = parseFloat(document.getElementById('modalFraisExpertise').value) || 0; // Add this line
    taskDataPayload.telephoneAssure = document.getElementById('modalTelephoneAssureInput').value;
    taskDataPayload.nomAgentAssurance = document.getElementById('modalNomAgentAssuranceInput').value;
    taskDataPayload.telephoneAgentAssurance = document.getElementById('modalTelephoneAgentAssuranceInput').value;

    taskDataPayload.montantForfait = forfaitInput ? parseFloat(forfaitInput.value) || 0 : 0;

    taskDataPayload.photoDate = document.getElementById('modalPhotoDate').value || null;
    taskDataPayload.factureStatut = document.getElementById('modalFactureStatut').value || '';
    taskDataPayload.factureDate = document.getElementById('modalFactureDate').value || null;
    taskDataPayload.notes = document.getElementById('modalNotes').value;

    const originalTask = allTasksData.find(t => String(t.id).trim() == String(currentTaskId).trim());
    const originalChecklist = originalTask ? (originalTask.checklist || {}) : {};
    // Add this block to handle the report sent checkbox
    const reportSentCheckbox = document.getElementById('modalReportSent');
    if (reportSentCheckbox && !reportSentSection.classList.contains('hidden')) {
        if (reportSentCheckbox.checked) {
            // If it's checked now but didn't have a date before, set a new date. Otherwise, keep the old date.
            taskDataPayload.rapportEnvoye = (originalTask ? originalTask.rapportEnvoye : null) || new Date().toISOString();
        } else {
            taskDataPayload.rapportEnvoye = null; // Clear the date if unchecked
        }
    }
    const checklistInputs = document.querySelectorAll('#detailsContent input[data-item]');
    const newChecklist = {};
    checklistInputs.forEach(input => {
        const key = input.dataset.item;
        const originalTimestamp = originalChecklist[key];

        if (input.checked) {
            newChecklist[key] = originalTimestamp || new Date().toISOString();
        } else {
            newChecklist[key] = null;
        }
    });
    taskDataPayload.checklist = newChecklist;

    if (devisStatusSelect) {
        taskDataPayload.devisStatus = devisStatusSelect.value;
    } else {
        taskDataPayload.devisStatus = '';
    }

    const {
        completed,
        total
    } = getChecklistProgress(taskDataPayload.checklist);
    if (taskDataPayload.devisStatus === 'Forfait' && taskDataPayload.montantForfait > 0) {
        taskDataPayload.statut = '✅ Terminé';
    } else if (completed === total) {
        taskDataPayload.statut = '✅ Terminé';
    } else if (completed > 0) {
        taskDataPayload.statut = '🚧 Mission inachevee';
    } else {
        taskDataPayload.statut = '📆 À faire';
    }

    try {
        const response = await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'cors',
            headers: {
                'Content-Type': 'text/plain;charset=utf-8'
            },
            body: JSON.stringify(taskDataPayload)
        });
        const result = await response.json();
        if (result.status !== 'success') throw new Error(result.message);

        closeModal();
        await fetchTasks();
        await fetchAdvancedTasks();
        await fetchNotifications();
    } catch (error) {
        console.error("Error saving changes: ", error);
        showError(`Erreur lors de la sauvegarde: ${error.message}`);
    } finally {
        loadingSpinner.classList.add('hidden');
    }
}

// --- AUTHENTICATION ---
async function initializeLogin() {
    loadingSpinner.classList.remove('hidden');
    loginButton.disabled = true;
    const success = await fetchAgents();
    if (success) {
        loginButton.disabled = false;
    }
    loadingSpinner.classList.add('hidden');
}

loginForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const email = loginForm.email.value;
    const password = loginForm.password.value;
    const user = agents.find(agent => agent.email === email && agent.password == password);

    if (user) {
        currentUser = user;
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        loginError.classList.add('hidden');
        initializeAppState();
    } else {
        loginError.textContent = "Email ou mot de passe incorrect.";
        loginError.classList.remove('hidden');
    }
});

async function initializeAppState() {
    if (!currentUser) return;

    loadingSpinner.classList.remove('hidden');
    loginPage.classList.add('hidden');
    appContainer.classList.remove('hidden');

    document.getElementById('userName').textContent = currentUser.name;
    document.getElementById('userRole').textContent = currentUser.role;
    const headerProfilePic = document.getElementById('headerProfilePicture');
    if (currentUser.profilepictureurl) {
        headerProfilePic.src = currentUser.profilepictureurl;
    } else {
        headerProfilePic.src = 'https://placehold.co/40x40';
    }

    if (currentUser.role.toLowerCase() === 'admin') {
        document.getElementById('navAdmin').classList.remove('hidden');
    } else {
        document.getElementById('navAdmin').classList.add('hidden');
    }

    if (currentUser.role.toLowerCase() === 'admin' || currentUser.role.toLowerCase() === 'assigner') {
        addTaskBtn.classList.remove('hidden');
        importBtn.classList.remove('hidden');
        fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'cors',
            headers: {
                'Content-Type': 'text/plain;charset=utf-8'
            },
            body: JSON.stringify({
                action: 'runDeadlineCheck'
            })
        }).then(res => res.json()).then(result => {
            console.log('Deadline check result:', result.message);
        }).catch(err => {
            console.error('Failed to run deadline check:', err);
        });
    } else {
        addTaskBtn.classList.add('hidden');
        importBtn.classList.add('hidden');
    }

    try {
        await Promise.all([fetchAgents(), fetchTasks(), fetchAdvancedTasks(), fetchNotifications(), fetchCalendarEvents()]);
    } catch (error) {
        console.error("Initial data fetch failed:", error);
        showError("Le chargement des données a échoué. Veuillez réessayer.");
    } finally {
        filterDataForView();
        populateFilters();
        updateDashboard();

        showPage('dashboardPage');
        if (currentUser.role.toLowerCase() === 'admin') {
            renderAdminPage();
        }

        notificationInterval = setInterval(fetchNotifications, 60000);
        setInterval(updateAllTimers, 1000); // Start the global timer
        loadingSpinner.classList.add('hidden');
    }
}


logoutButton.addEventListener('click', () => {
    currentUser = null;
    allTasksData = [];
    tasksData = [];
    notifications = [];
    advancedTasks = [];
    calendarEvents = [];
    clearInterval(notificationInterval);
    agentFilter.disabled = false;
    appContainer.classList.add('hidden');
    loginPage.classList.remove('hidden');
    document.getElementById('navAdmin').classList.add('hidden');
    localStorage.removeItem('currentUser');
});

// --- UI & RENDERING ---
function updateDashboard() {
    const total = tasksData.length;
    const completedTasks = tasksData.filter(t => normalizeString(getCleanedStatus(t.statut)).includes('termine'));
    const inProgressTasks = tasksData.filter(t => {
        const normalizedStatus = normalizeString(getCleanedStatus(t.statut));
        return normalizedStatus.includes('inachevee') || normalizedStatus.includes('en cours');
    });
    const todoTasks = tasksData.filter(t => normalizeString(getCleanedStatus(t.statut)).includes('a faire'));

    const statTotalEl = document.getElementById('statTotal');
    if (statTotalEl) statTotalEl.textContent = total;

    const statCompletedEl = document.getElementById('statCompleted');
    if (statCompletedEl) statCompletedEl.textContent = completedTasks.length;

    const statInProgressEl = document.getElementById('statInProgress');
    if (statInProgressEl) statInProgressEl.textContent = inProgressTasks.length;

    const statTodoEl = document.getElementById('statTodo');
    if (statTodoEl) statTodoEl.textContent = todoTasks.length;
    const initialOverdueTasks = tasksData.filter(t => t.isInitialTaskOverdue);
    const statInitialOverdueEl = document.getElementById('statInitialOverdue');
    if (statInitialOverdueEl) statInitialOverdueEl.textContent = initialOverdueTasks.length;

    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const overdueTasks = tasksData.filter(t => {
        const isCompleted = normalizeString(getCleanedStatus(t.statut)).includes('termine');
        if (isCompleted || !t.dateLimite) return false;

        if (t.devisStatus === "Client n'a pas envoyé") {
            return false;
        }

        return new Date(t.dateLimite) < today;
    });
    const statOverdueEl = document.getElementById('statOverdue');
    if (statOverdueEl) statOverdueEl.textContent = overdueTasks.length;
    renderOverdueTasksList(overdueTasks);

    const highDevisTasks = tasksData.filter(t => t.montantDevis > 20000);
    const statHighDevisEl = document.getElementById('statHighDevis');
    if (statHighDevisEl) statHighDevisEl.textContent = highDevisTasks.length;

    let totalCompletionDays = 0,
        completedWithDates = 0;
    completedTasks.forEach(t => {
        if (t.dateReception && t.dateAchevement) {
            const start = new Date(t.dateReception),
                end = new Date(t.dateAchevement);
            if (!isNaN(start) && !isNaN(end)) {
                totalCompletionDays += (end - start) / (1000 * 60 * 60 * 24);
                completedWithDates++;
            }
        }
    });
    const statAvgCompletionEl = document.getElementById('statAvgCompletion');
    if (statAvgCompletionEl) statAvgCompletionEl.textContent = `${completedWithDates > 0 ? (totalCompletionDays / completedWithDates).toFixed(1) : 'N/A'} jours`;

    renderAgentKPIs();
}

function renderAgentKPIs() {
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const agentStats = tasksData.reduce((acc, task) => {
        if (!task.agent) return acc;
        if (!acc[task.agent]) {
            acc[task.agent] = {
                completed: 0,
                inProgress: 0,
                todo: 0,
                overdue: 0,
                total: 0
            };
        }

        const normalizedStatus = normalizeString(getCleanedStatus(task.statut));
        const isCompleted = normalizedStatus.includes('termine');

        const isOverdue = !isCompleted && task.dateLimite && new Date(task.dateLimite) < today && task.devisStatus !== "Client n'a pas envoyé";

        if (isOverdue) {
            acc[task.agent].overdue++;
        } else if (isCompleted) {
            acc[task.agent].completed++;
        } else if (normalizedStatus.includes('inachevee') || normalizedStatus.includes('en cours')) {
            acc[task.agent].inProgress++;
        } else if (normalizedStatus.includes('a faire')) {
            acc[task.agent].todo++;
        }

        acc[task.agent].total++;
        return acc;
    }, {});

    const kpiContainer = document.getElementById('agentKpiContainer');
    kpiContainer.innerHTML = '';

    if (Object.keys(agentStats).length === 0) {
        kpiContainer.innerHTML = '<p class="text-center text-gray-500">Aucune donnée d\'agent à afficher.</p>';
        return;
    }

    Object.entries(agentStats).sort((a, b) => b[1].total - a[1].total).forEach(([agent, stats]) => {
        const total = stats.total;
        if (total === 0) return;

        const completionRate = (stats.completed / total) * 100;
        let rateColor = 'text-gray-800';
        if (completionRate > 75) {
            rateColor = 'text-green-600';
        } else if (completionRate > 40) {
            rateColor = 'text-yellow-500';
        } else {
            rateColor = 'text-red-600';
        }

        const agentCard = document.createElement('div');
        agentCard.className = 'border rounded-lg p-4 bg-gray-50 hover:shadow-md transition-shadow';
        agentCard.innerHTML = `
                <div class="flex justify-between items-start">
                    <p class="font-bold text-gray-800 text-lg">${agent}</p>
                    <div class="text-right">
                         <span class="font-bold text-xl ${rateColor}">${completionRate.toFixed(0)}%</span>
                         <p class="text-xs text-gray-500">Taux de Clôture</p>
                    </div>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                     <div class="bg-blue-600 h-2 rounded-full" style="width: ${completionRate}%"></div>
                </div>
                <div class="grid grid-cols-4 gap-2 text-center mt-4">
                    <div>
                        <p class="text-xs font-semibold text-gray-500">Total</p>
                        <p class="text-2xl font-bold text-gray-800">${stats.total}</p>
                    </div>
                    <div>
                        <p class="text-xs font-semibold text-green-600">Terminé</p>
                        <p class="text-2xl font-bold text-green-600">${stats.completed}</p>
                    </div>
                    <div>
                        <p class="text-xs font-semibold text-orange-500">En Cours</p>
                        <p class="text-2xl font-bold text-orange-500">${stats.inProgress + stats.todo}</p>
                    </div>
                    <div>
                        <p class="text-xs font-semibold text-red-600">En Retard</p>
                        <p class="text-2xl font-bold text-red-600">${stats.overdue}</p>
                    </div>
                </div>
            `;
        kpiContainer.appendChild(agentCard);
    });
}

function renderOverdueTasksList(overdueTasks) {
    const listContainer = document.getElementById('overdueTasksList');
    listContainer.innerHTML = overdueTasks.length === 0 ? `<p class="text-sm text-gray-500 text-center py-4">Aucun dossier en retard.</p>` : '';
    overdueTasks.slice(0, 10).forEach(task => {
        const item = document.createElement('div');
        item.className = 'overdue-item p-2 border-l-4 border-red-500 bg-red-50 rounded-r-lg cursor-pointer hover:bg-red-100 transition';
        item.dataset.taskId = task.id;
        item.innerHTML = `<p class="font-semibold text-sm text-gray-800">${task.ref} - ${task.assure}</p><p class="text-xs text-gray-600">Agent: ${task.agent} | Limite: ${new Date(task.dateLimite).toLocaleDateString('fr-FR')}</p>`;
        listContainer.appendChild(item);
    });
}

function renderProductivityPage() {
    if (Object.keys(productivityCharts).length > 0) {
        productivityCharts.missions?.destroy();
        productivityCharts.time?.destroy();
    }

    const targetDateStr = productivityDateInput.value;
    if (!targetDateStr) return;

    const agentProductivity = calculateAgentProductivity(new Date(targetDateStr));
    productivityTableBody.innerHTML = '';
    const productiveAgents = Object.entries(agentProductivity).filter(([name, stats]) => stats.totalCompleted > 0);

    if (productiveAgents.length === 0) {
        productivityTableBody.innerHTML = '<tr><td colspan="7" class="text-center p-4">Aucune mission terminée à cette date.</td></tr>';
        const missionsCtx = document.getElementById('missionsChart').getContext('2d');
        const timeCtx = document.getElementById('timeChart').getContext('2d');
        missionsCtx.clearRect(0, 0, missionsCtx.canvas.width, missionsCtx.canvas.height);
        timeCtx.clearRect(0, 0, timeCtx.canvas.width, timeCtx.canvas.height);
        return;
    }

    const missionCompletionItems = ["Carte Grise", "Constat", "Dégâts extérieurs", "Dégâts intérieurs", "Photos roues et au dessous", "Compteur Km", "VIN"];
    const dayStart = new Date(targetDateStr);
    dayStart.setUTCHours(0, 0, 0, 0);
    const dayEnd = new Date(dayStart);
    dayEnd.setUTCDate(dayStart.getUTCDate() + 1);

    productiveAgents.forEach(([agentName, stats]) => {
        const performance = stats.allocatedHours > 0 ? ((stats.allocatedHours / WORK_DAY_HOURS) * 100).toFixed(0) : 0;
        const agentId = agentName.replace(/\s+/g, '-');

        // --- Main Agent Row ---
        const tr = document.createElement('tr');
        tr.className = "border-b";
        tr.innerHTML = `
            <td class="p-4 align-middle font-semibold text-gray-900 flex items-center">
                <button class="toggle-details-btn p-1 rounded-full hover:bg-gray-200 mr-2" data-target-id="details-${agentId}">
                    <svg class="w-5 h-5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
                ${agentName}
            </td>
            <td class="p-4 align-middle text-center">${stats.newlyCompleted}</td>
            <td class="p-4 align-middle text-center">${stats.oldCompleted}</td>
            <td class="p-4 align-middle text-center font-bold">${stats.totalCompleted}</td>
            <td class="p-4 align-middle text-center">${stats.allocatedHours.toFixed(2)}</td>
            <td class="p-4 align-middle text-center">${stats.freeHours.toFixed(2)}</td>
            <td class="p-4 align-middle text-center">${performance}%</td>
        `;
        productivityTableBody.appendChild(tr);

        // --- Hidden Details Row ---
        const detailsTr = document.createElement('tr');
        detailsTr.id = `details-${agentId}`;
        detailsTr.className = 'hidden';

        const finishedDossiers = allTasksData.filter(task => {
            if (task.agent !== agentName || !task.checklist) return false;
            const timestamps = missionCompletionItems.map(item => task.checklist[item]).filter(Boolean);
            if (timestamps.length !== missionCompletionItems.length) return false;
            const completionDate = new Date(Math.max(...timestamps.map(ts => new Date(ts))));
            return completionDate >= dayStart && completionDate < dayEnd;
        });

        let detailsHtml = '<p class="text-gray-500">Aucun dossier à afficher.</p>';
        if (finishedDossiers.length > 0) {
            detailsHtml = finishedDossiers.map(dossier => `
                <div class="p-2 border-b hover:bg-gray-100 cursor-pointer dossier-list-item" data-task-id="${dossier.id}">
                    <span class="font-bold text-blue-700">${dossier.ref}</span> - <span>${dossier.assure}</span>
                </div>
            `).join('');
        }

        detailsTr.innerHTML = `<td colspan="7" class="p-4 bg-gray-50">${detailsHtml}</td>`;
        productivityTableBody.appendChild(detailsTr);
    });
    
    // Chart rendering logic
    const agentNames = productiveAgents.map(([name, stats]) => name);
    const newlyCompletedData = productiveAgents.map(([name, stats]) => stats.newlyCompleted);
    const oldCompletedData = productiveAgents.map(([name, stats]) => stats.oldCompleted);
    const allocatedHoursData = productiveAgents.map(([name, stats]) => stats.allocatedHours);
    const freeHoursData = productiveAgents.map(([name, stats]) => stats.freeHours);

    const missionsCtx = document.getElementById('missionsChart').getContext('2d');
    productivityCharts.missions = new Chart(missionsCtx, {
        type: 'bar', data: { labels: agentNames, datasets: [{ label: 'Nouveaux Dossiers (J)', data: newlyCompletedData, backgroundColor: 'rgba(59, 130, 246, 0.7)' }, { label: 'Anciens Dossiers', data: oldCompletedData, backgroundColor: 'rgba(249, 115, 22, 0.7)' }] },
        options: { plugins: { title: { display: false } }, responsive: true, scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true, ticks: { stepSize: 1 } } } }
    });
    const timeCtx = document.getElementById('timeChart').getContext('2d');
    productivityCharts.time = new Chart(timeCtx, {
        type: 'bar', data: { labels: agentNames, datasets: [{ label: 'Temps Alloué (h)', data: allocatedHoursData, backgroundColor: 'rgba(239, 68, 68, 0.7)' }, { label: 'Temps Libre (h)', data: freeHoursData, backgroundColor: 'rgba(34, 197, 94, 0.7)' }] },
        options: { scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true, max: WORK_DAY_HOURS } } }
    });
}

function calculateAgentProductivity(targetDate) {
    const agentStats = {};
    const targetDateStr = targetDate.toISOString().split('T')[0];

    // Use a date range to avoid timezone issues
    const dayStart = new Date(targetDateStr);
    dayStart.setUTCHours(0, 0, 0, 0);
    const dayEnd = new Date(dayStart);
    dayEnd.setUTCDate(dayStart.getUTCDate() + 1);

    const missionCompletionItems = ["Carte Grise", "Constat", "Dégâts extérieurs", "Dégâts intérieurs", "Photos roues et au dessous", "Compteur Km", "VIN"];

    agents.forEach(agent => {
        if (agent.role.toLowerCase() === 'employee') {
            agentStats[agent.name] = {
                newlyCompleted: 0,
                oldCompleted: 0,
                totalCompleted: 0,
                allocatedHours: 0,
                freeHours: WORK_DAY_HOURS
            };
        }
    });

    allTasksData.forEach(task => {
        if (!task.agent || !task.checklist) return;

        const timestamps = missionCompletionItems.map(item => task.checklist[item]).filter(Boolean);

        if (timestamps.length === missionCompletionItems.length) {
            const completionDate = new Date(Math.max(...timestamps.map(ts => new Date(ts))));

            // Check if completion is within the correct UTC day
            if (completionDate >= dayStart && completionDate < dayEnd) {
                if (!agentStats[task.agent]) {
                    agentStats[task.agent] = {
                        newlyCompleted: 0,
                        oldCompleted: 0,
                        totalCompleted: 0,
                        allocatedHours: 0,
                        freeHours: WORK_DAY_HOURS
                    };
                }

                const receptionDateStr = task.dateReception ? new Date(task.dateReception).toISOString().split('T')[0] : null;

                if (receptionDateStr === targetDateStr) {
                    agentStats[task.agent].newlyCompleted++;
                } else {
                    agentStats[task.agent].oldCompleted++;
                }
            }
        }
    });

    for (const agentName in agentStats) {
        const stats = agentStats[agentName];
        stats.totalCompleted = stats.newlyCompleted + stats.oldCompleted;
        stats.allocatedHours = (stats.totalCompleted * MISSION_DURATION_MIN) / 60;
        stats.freeHours = WORK_DAY_HOURS - stats.allocatedHours;
        if (stats.freeHours < 0) stats.freeHours = 0;
    }

    return agentStats;
}

// --- NEW: Statistics Page Functions ---

function calculateStatsForPeriod(period) {
    const now = new Date();
    let startDate = new Date();

    if (period === 'weekly') {
        startDate.setDate(now.getDate() - 7);
    } else if (period === 'monthly') {
        startDate.setMonth(now.getMonth() - 1);
    } else if (period === 'quarterly') {
        startDate.setMonth(now.getMonth() - 3);
    }
    startDate.setHours(0, 0, 0, 0);

    const filteredTasks = allTasksData.filter(task => {
        const receptionDate = new Date(task.dateReception);
        return receptionDate >= startDate && receptionDate <= now;
    });

    const completedTasks = filteredTasks.filter(task =>
        task.dateAchevement && new Date(task.dateAchevement) <= now
    );

    let totalCompletionMs = 0;
    let tasksWithDates = 0;
    completedTasks.forEach(task => {
        if (task.dateReception && task.dateAchevement) {
            const start = new Date(task.dateReception);
            const end = new Date(task.dateAchevement);
            if (!isNaN(start) && !isNaN(end)) {
                totalCompletionMs += (end - start);
                tasksWithDates++;
            }
        }
    });

    const avgCompletionTime = tasksWithDates > 0 ? (totalCompletionMs / tasksWithDates) / (1000 * 60 * 60 * 24) : 0;

    const agentPerformance = completedTasks.reduce((acc, task) => {
        if (task.agent) {
            acc[task.agent] = (acc[task.agent] || 0) + 1;
        }
        return acc;
    }, {});

    const sortedAgents = Object.entries(agentPerformance).sort((a, b) => b[1] - a[1]);

    return {
        totalReceived: filteredTasks.length,
        totalCompleted: completedTasks.length,
        avgCompletionTime: avgCompletionTime,
        chartLabels: sortedAgents.map(a => a[0]),
        chartData: sortedAgents.map(a => a[1])
    };
}

function renderStatsPage(period = 'weekly') {
    const tabs = {
        weekly: statsWeeklyBtn,
        monthly: statsMonthlyBtn,
        quarterly: statsQuarterlyBtn
    };
    Object.values(tabs).forEach(tab => tab.classList.remove('active'));
    if (tabs[period]) {
        tabs[period].classList.add('active');
    }

    const statsData = calculateStatsForPeriod(period);

    statsContent.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="stat-card bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <h3 class="text-sm font-medium text-gray-500">Dossiers Reçus</h3>
                    <p class="text-3xl font-bold text-blue-600 mt-2">${statsData.totalReceived}</p>
                </div>
                <div class="stat-card bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <h3 class="text-sm font-medium text-gray-500">Dossiers Terminés</h3>
                    <p class="text-3xl font-bold text-green-600 mt-2">${statsData.totalCompleted}</p>
                </div>
                <div class="stat-card bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <h3 class="text-sm font-medium text-gray-500">Délai Moyen de Clôture</h3>
                    <p class="text-3xl font-bold text-gray-800 mt-2">${statsData.avgCompletionTime.toFixed(1)} jours</p>
                </div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <h3 class="text-lg font-semibold mb-4 text-center">Dossiers Terminés par Agent (${period === 'weekly' ? 'Cette Semaine' : period === 'monthly' ? 'Ce Mois' : 'Ce Trimestre'})</h3>
                <canvas id="statsChartCanvas"></canvas>
            </div>
        `;

    if (statsChart) {
        statsChart.destroy();
    }

    const ctx = document.getElementById('statsChartCanvas').getContext('2d');
    statsChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: statsData.chartLabels,
            datasets: [{
                label: 'Dossiers Terminés',
                data: statsData.chartData,
                backgroundColor: 'rgba(59, 130, 246, 0.7)',
                borderColor: 'rgba(59, 130, 246, 1)',
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
}

function filterTasksByAgent(agentName) {
    searchInput.value = '';
    companyFilter.value = 'all';
    statusFilter.value = 'all';
    if (currentUser.role.toLowerCase() === 'admin' || currentUser.role.toLowerCase() === 'assigner') {
        agentFilter.value = agentName;
    }
    filterAndRender();
}

function renderTasks(tasks) {
    taskGrid.innerHTML = '';
    noResultsDiv.classList.toggle('hidden', tasks.length > 0);
    taskGrid.classList.toggle('hidden', tasks.length === 0);

    tasks.forEach(task => {
        const { completed, total } = getChecklistProgress(task.checklist || {});
        const progress = total > 0 ? (completed / total) * 100 : 0;
        let statusClass = 'status-afaire', statusText = getCleanedStatus(task.statut);
        const normalizedStatus = normalizeString(statusText);

        if (normalizedStatus.includes('annule')) { 
            statusClass = 'status-annule';
            statusText = 'Annulé';
        } else if (normalizedStatus.includes('termine')) { 
            statusClass = 'status-termine !leading-tight !p-2 text-center'; 
            if (task.rapportEnvoye) {
                const sentDate = new Date(task.rapportEnvoye).toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' });
                statusText = `Terminé <span class="block text-[10px] normal-case font-normal">Rapport envoyé ${sentDate}</span>`;
            } else {
                statusText = `Terminé <span class="block text-[10px] normal-case font-normal text-orange-600">Rapport en attente</span>`;
            }
        } else if (normalizedStatus.includes('inachevee') || normalizedStatus.includes('en cours')) {
            statusClass = 'status-inachevee';
            statusText = 'En cours';
        }

        let stepText = '';
        let deadlineText = '';
        const isStep1Complete = task.step1CompletionDate != null;
        const isTermine = normalizedStatus.includes('termine');
        const receptionDate = task.dateReception ? new Date(task.dateReception) : null;

        if (isTermine) {
            stepText = 'Étape 3: Terminé';
        } else if (isStep1Complete) {
            stepText = 'Étape 2: Réparation';
            const step1Date = new Date(task.step1CompletionDate);
            const deadline = new Date(step1Date.setDate(step1Date.getDate() + 21));
            deadlineText = `Deadline: ${deadline.toLocaleDateString('fr-FR')}`;
        } else {
            stepText = 'Étape 1: Documents & Devis';
            if (receptionDate) {
                const deadlineReceptionDate = new Date(receptionDate);
                const deadline = new Date(deadlineReceptionDate.setDate(deadlineReceptionDate.getDate() + 3));
                deadlineText = `Deadline: ${deadline.toLocaleDateString('fr-FR')}`;
            }
        }

        const urgentIcon = task.urgent ? `<span class="text-red-500" title="Dossier Urgent"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 3.001-1.742 3.001H4.42c-1.53 0-2.493-1.667-1.743-3.001l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></span>` : '';
        const cardBorderClass = task.urgent ? 'border-red-500 border-2' : 'border-gray-200';
        const initialOverdueBadge = task.isInitialTaskOverdue ? `<span class="text-xs font-bold text-red-700 bg-red-100 px-2 py-1 rounded-full ml-2">EN RETARD</span>` : '';
        const card = document.createElement('div');
        card.className = `task-card bg-white p-5 rounded-xl shadow-sm ${cardBorderClass} hover:shadow-lg hover:border-blue-500 transition-all duration-300 cursor-pointer flex flex-col justify-between`;
        card.dataset.taskId = task.id;
        card.innerHTML = `
            <div>
                <div class="flex justify-between items-start">
                    <div class="flex items-center gap-1">
                        <p class="text-sm font-bold text-blue-600">${task.ref}</p>${initialOverdueBadge}
                        ${urgentIcon}
                    </div>
                    <span class="status-badge ${statusClass}">${statusText || 'N/A'}</span>
                </div>
                <h3 class="font-bold text-lg mt-2 truncate">${task.assure}</h3>
                <div class="mt-2 space-y-1.5 text-sm text-gray-600">
                    <p class="flex items-center gap-2 truncate">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 flex-shrink-0 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a1 1 0 110 2h-3a1 1 0 01-1-1v-2a1 1 0 00-1-1H9a1 1 0 00-1 1v2a1 1 0 01-1 1H5a1 1 0 110-2V4zm3 1h2v2H7V5zm2 4H7v2h2V9zm2-4h2v2h-2V5zm2 4h-2v2h2V9z" /></svg>
                        <span class="truncate">${task.compagnie || 'Compagnie N/A'}</span>
                    </p>
                    <p class="flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 flex-shrink-0 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M15 5a1 1 0 011 1v8a1 1 0 11-2 0V6a1 1 0 011-1zM9 5a1 1 0 011 1v8a1 1 0 11-2 0V6a1 1 0 011-1zM5 5a1 1 0 011 1v8a1 1 0 11-2 0V6a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                        <span class="font-mono bg-gray-100 px-2 py-0.5 rounded text-gray-800 tracking-wider">${task.matricule || 'N/A'}</span>
                    </p>
                </div>
                <p class="text-sm text-gray-500 truncate mt-2">${task.marqueModele || ''}</p>
            </div>
            <div class="mt-4 pt-4 border-t border-gray-100">
                ${task.isTimerActive ? `
                <div class="countdown-timer flex items-center justify-center gap-1.5 text-sm font-bold p-1.5 rounded-md mb-3" data-reception-date="${task.dateReception}">
                </div>` : ''}
                <div class="flex justify-between items-center mb-1">
                    <span class="text-xs font-semibold text-gray-600">Progression</span>
                    <span class="text-xs font-bold text-gray-700">${completed}/${total}</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${progress}%"></div>
                </div>
                <div class="text-xs text-gray-500 mt-3"><strong>Agent:</strong> ${task.agent || 'Non assigné'}</div>
                <div class="flex justify-between items-center mt-2">
                   <div class="text-xs font-bold text-indigo-600 p-1 bg-indigo-50 rounded-md text-center">${stepText}</div>
                   <div class="text-xs font-semibold text-red-600">${deadlineText}</div>
                </div>
            </div>`;
        taskGrid.appendChild(card);
    });
}

function renderFacturationPage(filter = 'all') {
    const facturationTableBody = document.getElementById('facturationTableBody');
    const companyStatsGrid = document.getElementById('companyStatsGrid');

    const billableDossiers = allTasksData.filter(task =>
        normalizeString(getCleanedStatus(task.statut)).includes('termine') &&
        task.fraisExpertise > 0
    );

    // --- NEW: Calculate stats per company ---
    const companyStats = billableDossiers.reduce((acc, task) => {
        const company = task.compagnie || 'Non Spécifié';
        if (!acc[company]) {
            acc[company] = {
                paid: 0,
                pending: 0
            };
        }
        if (task.datePaiement) {
            acc[company].paid += (parseFloat(task.fraisExpertise) || 0);
        } else {
            acc[company].pending += (parseFloat(task.fraisExpertise) || 0);
        }
        return acc;
    }, {});

    // --- NEW: Render company stat cards ---
    companyStatsGrid.innerHTML = '';
    const sortedCompanies = Object.entries(companyStats).sort((a, b) => b[1].pending - a[1].pending);

    if (sortedCompanies.length === 0) {
        companyStatsGrid.innerHTML = '<p class="text-gray-500 col-span-full">Aucune donnée de facturation à afficher.</p>';
    } else {
        sortedCompanies.forEach(([company, stats]) => {
            const card = document.createElement('div');
            card.className = 'bg-white p-4 rounded-xl shadow-sm border';
            card.innerHTML = `
                    <h4 class="font-bold text-gray-800 truncate">${company}</h4>
                    <div class="mt-2 space-y-1 text-sm">
                        <div class="flex justify-between items-center text-green-600">
                            <span class="font-medium">Payé:</span>
                            <span class="font-bold">${stats.paid.toLocaleString('fr-MA')} DH</span>
                        </div>
                        <div class="flex justify-between items-center text-orange-600">
                            <span class="font-medium">En Attente:</span>
                            <span class="font-bold">${stats.pending.toLocaleString('fr-MA')} DH</span>
                        </div>
                    </div>
                `;
            companyStatsGrid.appendChild(card);
        });
    }


    // --- Existing logic for global KPIs and table ---
    const now = new Date();
    const currentMonth = now.getMonth();
    const currentYear = now.getFullYear();

    const totalEnAttente = billableDossiers
        .filter(t => !t.datePaiement)
        .reduce((sum, task) => sum + (parseFloat(task.fraisExpertise) || 0), 0);

    const totalPayeCeMois = billableDossiers
        .filter(t => {
            const paymentDate = t.datePaiement ? new Date(t.datePaiement) : null;
            return paymentDate && paymentDate.getMonth() === currentMonth && paymentDate.getFullYear() === currentYear;
        })
        .reduce((sum, task) => sum + (parseFloat(task.fraisExpertise) || 0), 0);

    const countEnAttente = billableDossiers.filter(t => !t.datePaiement).length;

    document.getElementById('facturationTotalEnAttente').textContent = `${totalEnAttente.toLocaleString('fr-MA')} DH`;
    document.getElementById('facturationTotalPaye').textContent = `${totalPayeCeMois.toLocaleString('fr-MA')} DH`;
    document.getElementById('facturationCountEnAttente').textContent = countEnAttente;

    let filteredDossiers = billableDossiers;
    if (filter === 'pending') {
        filteredDossiers = billableDossiers.filter(task => !task.datePaiement);
    } else if (filter === 'paid') {
        filteredDossiers = billableDossiers.filter(task => !!task.datePaiement);
    }

    facturationTableBody.innerHTML = '';
    if (filteredDossiers.length === 0) {
        facturationTableBody.innerHTML = `<tr><td colspan="7" class="text-center p-8 text-gray-500">Aucun dossier trouvé.</td></tr>`;
        return;
    }

    filteredDossiers.forEach(task => {
        const tr = document.createElement('tr');
        const isPaid = !!task.datePaiement;
        const statusText = isPaid ? 'Payé' : 'En Attente';
        const statusColor = isPaid ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800';

        tr.innerHTML = `
                <td class="p-4 font-semibold text-blue-600">${task.ref}</td>
                <td class="p-4">${task.assure}</td>
                <td class="p-4">${task.compagnie}</td>
                <td class="p-4 font-medium">${(task.fraisExpertise || 0).toLocaleString('fr-MA')} DH</td>
                <td class="p-4">
                    <span class="px-2 py-1 text-xs font-semibold rounded-full ${statusColor}">${statusText}</span>
                </td>
                <td class="p-4">${isPaid ? new Date(task.datePaiement).toLocaleDateString('fr-FR') : 'N/A'}</td>
                <td class="p-4">
                    ${!isPaid ? `<button data-task-id="${task.id}" class="validate-payment-btn bg-green-500 text-white text-xs font-bold py-1 px-3 rounded-full hover:bg-green-600">Valider Paiement</button>` : ''}
                </td>
            `;
        facturationTableBody.appendChild(tr);
    });
}

// --- UTILITY & MODAL FUNCTIONS ---
function showError(message) {
    generalErrorMessage.textContent = message;
    generalErrorDiv.classList.remove('hidden');
    setTimeout(() => {
        generalErrorDiv.classList.add('hidden');
    }, 6000);
}

function getChecklistProgress(checklist = {}) {
    return {
        completed: Object.values(checklist).filter(val => val !== null).length,
        total: Object.keys(checklist).length
    };
}

function populateFilters() {
    agentFilter.innerHTML = '<option value="all">Tous les agents</option>';
    [...new Set(allTasksData.map(task => task.agent).filter(Boolean))].sort().forEach(agent => {
        agentFilter.appendChild(new Option(agent, agent));
    });
    companyFilter.innerHTML = '<option value="all">Toutes les compagnies</option>';
    [...new Set(allTasksData.map(task => task.compagnie).filter(Boolean))].sort().forEach(company => {
        companyFilter.appendChild(new Option(company, company));
    });
}

function filterAndRender(options = {}) {
    let filteredTasks = [...tasksData];
    const agent = agentFilter.value,
        company = companyFilter.value,
        status = statusFilter.value;
    const searchTerm = normalizeString(searchInput.value);

    if ((currentUser.role === 'admin' || currentUser.role.toLowerCase() === 'assigner') && agent !== 'all') {
        filteredTasks = filteredTasks.filter(task => task.agent === agent);
    }
    if (company !== 'all') filteredTasks = filteredTasks.filter(task => task.compagnie === company);
    if (status !== 'all') {
        if (status === 'inachevee') {
            filteredTasks = filteredTasks.filter(task => {
                const s = normalizeString(getCleanedStatus(task.statut));
                return s.includes('inachevee') || s.includes('en cours');
            });
        } else if (status === 'initialOverdue') { // THIS IS THE NEW PART
            filteredTasks = filteredTasks.filter(task => task.isInitialTaskOverdue);
        } else {
            const s = normalizeString(status);
            filteredTasks = filteredTasks.filter(task => task.statut && normalizeString(getCleanedStatus(task.statut)).includes(s));
        }
    }
    
    if (searchTerm) {
        filteredTasks = filteredTasks.filter(task =>
            (normalizeString(task.ref).includes(searchTerm)) ||
            (normalizeString(task.assure).includes(searchTerm)) ||
            (normalizeString(task.matricule).includes(searchTerm)) ||
            (normalizeString(task.marqueModele).includes(searchTerm)) ||
            (normalizeString(task.natureDossier).includes(searchTerm))
        );
    }

    if (options.overdueOnly) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        filteredTasks = filteredTasks.filter(t => {
            const isCompleted = normalizeString(getCleanedStatus(t.statut)).includes('termine');
            if (isCompleted || !t.dateLimite) return false;

            if (t.devisStatus === "Client n'a pas envoyé") {
                return false;
            }

            return new Date(t.dateLimite) < today;
        });
    }

    if (options.highDevisOnly) {
        filteredTasks = filteredTasks.filter(t => t.montantDevis > 20000);
    }

    renderTasks(filteredTasks);
}

function navigateToTasksWithStatus(status) {
    searchInput.value = '';
    companyFilter.value = 'all';
    if (currentUser.role.toLowerCase() === 'admin' || currentUser.role.toLowerCase() === 'assigner') {
        agentFilter.value = 'all';
    }

    statusFilter.value = status;
    showPage('dossiersPage');
    filterAndRender();
}

function navigateToTasksWithOverdueFilter() {
    searchInput.value = '';
    companyFilter.value = 'all';
    statusFilter.value = 'all';
    if (currentUser.role.toLowerCase() === 'admin' || currentUser.role.toLowerCase() === 'assigner') {
        agentFilter.value = 'all';
    }

    showPage('dossiersPage');
    filterAndRender({
        overdueOnly: true
    });
}

function navigateToTasksWithHighDevis() {
    searchInput.value = '';
    companyFilter.value = 'all';
    statusFilter.value = 'all';
    if (currentUser.role.toLowerCase() === 'admin' || currentUser.role.toLowerCase() === 'assigner') {
        agentFilter.value = 'all';
    }

    showPage('dossiersPage');
    filterAndRender({
        highDevisOnly: true
    });
}

function openModalForNewTask() {
    currentTaskId = null;
    document.getElementById('modalTitle').textContent = 'Créer un Nouveau Dossier';
    document.getElementById('modalSubtitle').textContent = 'Veuillez remplir les détails ci-dessous.';

    switchModalTab('details');
    tabActivity.classList.add('hidden');
    tabFiles.classList.add('hidden');

    modalDisplayGrid.classList.add('hidden');
    modalInputGrid.classList.remove('hidden');

    ['modalRefInput', 'modalAssureInput', 'modalMatriculeInput', 'modalCompagnieInput', 'modalDateSinistreInput', 'modalMarqueModeleInput', 'modalNatureDossierInput', 'modalMontantDevis', 'modalDevisRectifie', 'modalMontantFacture', 'modalNotes', 'modalPhotoDate', 'modalFactureDate', 'modalMontantForfait'].forEach(id => {
        const element = document.getElementById(id);
        if (element) element.value = '';
    });
    document.getElementById('modalFactureStatut').value = '';

    agentAssignmentSection.classList.remove('hidden');
    modalAgentAssign.innerHTML = '<option value="">Non assigné</option>';
    agents.filter(a => a.role === 'employee').forEach(emp => {
        modalAgentAssign.appendChild(new Option(emp.name, emp.name));
    });

    const step1Items = ["Carte Grise", "Constat", "Dégâts extérieurs", "Dégâts intérieurs", "Photos roues et au dessous", "Compteur Km", "VIN", "Devis"];
    const step2Items = ["Photos en cours et après réparation"];

    const checklistContainer = document.getElementById('modalChecklist');
    checklistContainer.innerHTML = '';
    step1Items.forEach(key => {
        const item = document.createElement('div');
        const uniqueId = `check-new-${key.replace(/\s+/g, '-')}`;

        if (key === "Devis") {
            item.className = 'flex flex-col items-start w-full';
            item.innerHTML = `
                        <div class="flex items-center justify-between w-full">
                            <div class="flex items-center">
                                <input id="${uniqueId}" data-item="${key}" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <label for="${uniqueId}" class="ml-3 block text-sm text-gray-900">${key}</label>
                            </div>
                        </div>
                        <div id="devis-reason-container" class="mt-2 pl-7 w-full">
                            <select id="devisStatusSelect" class="w-full p-1 border border-gray-300 rounded-md text-xs">
                                <option value="">Raison (si non reçu)...</option>
                                <option value="Agent n'a pas encore traité">Agent n'a pas encore traité</option>
                                <option value="Client n'a pas envoyé">Client n'a pas envoyé</option>
                                <option value="Forfait">Forfait</option>
                            </select>
                        </div>
                        <div id="forfait-amount-container" class="hidden mt-2 pl-7 w-full">
                           <input type="number" id="modalMontantForfait" class="w-full p-1 border border-gray-300 rounded-md text-xs" placeholder="Montant Forfait (DH)">
                        </div>
                    `;
        } else {
            item.className = 'flex items-center justify-between w-full';
            item.innerHTML = `
                        <div class="flex items-center">
                           <input id="${uniqueId}" data-item="${key}" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <label for="${uniqueId}" class="ml-3 block text-sm text-gray-900">${key}</label>
                        </div>
                    `;
        }
        checklistContainer.appendChild(item);
    });

    const step2ChecklistContainer = document.getElementById('step2Checklist');
    step2ChecklistContainer.innerHTML = '';
    step2Items.forEach(key => {
        const item = document.createElement('div');
        item.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
        item.innerHTML = `
                <div class="flex items-center">
                    <input id="check-new-${key.replace(/\s+/g, '-')}" data-item="${key}" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                    <label for="check-new-${key.replace(/\s+/g, '-')}" class="ml-3 block text-sm font-semibold text-gray-900">${key}</label>
                </div>
                <button type="button" class="upload-step2-btn bg-blue-100 text-blue-700 text-xs font-bold py-1 px-3 rounded-full hover:bg-blue-200">Ajouter Photos</button>
            `;
        step2ChecklistContainer.appendChild(item);
    });

    const newDevisCheckbox = document.getElementById('check-new-Devis');
    const newDevisReasonContainer = document.getElementById('devis-reason-container');
    const forfaitAmountContainer = document.getElementById('forfait-amount-container');
    const devisStatusSelect = document.getElementById('devisStatusSelect');

    if (newDevisCheckbox && newDevisReasonContainer && forfaitAmountContainer && devisStatusSelect) {
        newDevisCheckbox.addEventListener('change', () => {
            newDevisReasonContainer.classList.toggle('hidden', newDevisCheckbox.checked);
            if (newDevisCheckbox.checked) {
                forfaitAmountContainer.classList.add('hidden');
                devisStatusSelect.value = '';
            }
        });

        devisStatusSelect.addEventListener('change', () => {
            if (devisStatusSelect.value === 'Forfait') {
                forfaitAmountContainer.classList.remove('hidden');
                newDevisCheckbox.checked = true;
                newDevisReasonContainer.classList.add('hidden');
            } else {
                forfaitAmountContainer.classList.add('hidden');
            }
        });
    }


    document.getElementById('modalStepper').classList.add('hidden');
    cancelDossierBtn.classList.add('hidden'); // Add this line

    modal.classList.remove('hidden');
    setTimeout(() => {
        modal.classList.remove('opacity-0');
        modalContent.classList.remove('scale-95');
    }, 10);
}

async function openModal(taskId) {
    currentTaskId = taskId;
    const task = allTasksData.find(t => String(t.id).trim() == String(taskId).trim());
    if (!task) {
        showError("Le dossier demandé est introuvable.");
        return;
    }

    switchModalTab('details');
    tabActivity.classList.remove('hidden');
    tabFiles.classList.remove('hidden');
    document.getElementById('modalStepper').classList.remove('hidden');

    modalDisplayGrid.classList.remove('hidden');
    modalInputGrid.classList.add('hidden');

    document.getElementById('modalTitle').textContent = `Dossier: ${task.ref}`;
    document.getElementById('modalSubtitle').textContent = task.assure;
    document.getElementById('modalDateReception').textContent = task.dateReception ? new Date(task.dateReception).toLocaleDateString('fr-FR') : 'N/A';
    document.getElementById('modalAgent').textContent = task.agent || 'Non assigné';
    document.getElementById('modalMatricule').textContent = task.matricule;
    document.getElementById('modalCompagnie').textContent = task.compagnie;
    document.getElementById('modalDateSinistre').textContent = task.dateSinistre ? new Date(task.dateSinistre).toLocaleDateString('fr-FR') : 'N/A';
    document.getElementById('modalMarqueModele').textContent = task.marqueModele || '';
    document.getElementById('modalNatureDossier').textContent = task.natureDossier || '';


    const montantDevisInput = document.getElementById('modalMontantDevis');
    if (montantDevisInput) montantDevisInput.value = task.montantDevis || '';

    const devisRectifieInput = document.getElementById('modalDevisRectifie');
    if (devisRectifieInput) devisRectifieInput.value = task.devisRectifie || '';

    const montantFactureInput = document.getElementById('modalMontantFacture');
    document.getElementById('modalTelephoneAssure').textContent = task.telephoneAssure || 'N/A';
    document.getElementById('modalNomAgentAssurance').textContent = task.nomAgentAssurance || 'N/A';
    document.getElementById('modalTelephoneAgentAssurance').textContent = task.telephoneAgentAssurance || 'N/A';
    
    // ----- FIX STARTS HERE -----
    // Populate the hidden input fields as well to prevent data erasure on save
    document.getElementById('modalTelephoneAssureInput').value = task.telephoneAssure || '';
    document.getElementById('modalNomAgentAssuranceInput').value = task.nomAgentAssurance || '';
    document.getElementById('modalTelephoneAgentAssuranceInput').value = task.telephoneAgentAssurance || '';
    // ----- FIX ENDS HERE -----


    if (montantFactureInput) montantFactureInput.value = task.montantFacture || '';
    document.getElementById('modalFraisExpertise').value = task.fraisExpertise || ''; // Add this line

    // -- NEW: Render communication actions and logs --
    const clientContactActions = document.getElementById('clientContactActions');
    const agentContactActions = document.getElementById('agentContactActions');
    clientContactActions.innerHTML = '';
    agentContactActions.innerHTML = '';

    const whatsappMessage = `Bonjour, concernant votre dossier d'accident N° ${task.ref}, assuré(e) ${task.assure}.`;

    if (task.telephoneAssure) {
        clientContactActions.innerHTML = `
            <button class="contact-btn bg-blue-500 text-white py-1 px-3 rounded-lg text-sm" data-type="call" data-target="client">Log Appel</button>
            <a href="https://wa.me/${task.telephoneAssure}?text=${encodeURIComponent(whatsappMessage)}" target="_blank" class="contact-btn bg-green-500 text-white py-1 px-3 rounded-lg text-sm" data-type="whatsapp" data-target="client">WhatsApp</a>
        `;
    }
    if (task.telephoneAgentAssurance) {
        agentContactActions.innerHTML = `
            <button class="contact-btn bg-blue-500 text-white py-1 px-3 rounded-lg text-sm" data-type="call" data-target="insurance_agent">Log Appel</button>
            <a href="https://wa.me/${task.telephoneAgentAssurance}?text=${encodeURIComponent(whatsappMessage)}" target="_blank" class="contact-btn bg-green-500 text-white py-1 px-3 rounded-lg text-sm" data-type="whatsapp" data-target="insurance_agent">WhatsApp</a>
        `;
    }

    document.getElementById('clientCommLog').innerHTML = `
        <p><strong>Appels:</strong> ${task.appelsAssure.join(' | ') || 'Aucun'}</p>
        <p><strong>WhatsApp:</strong> ${task.whatsAppAssure.join(' | ') || 'Aucun'}</p>
    `;
    document.getElementById('agentCommLog').innerHTML = `
        <p><strong>Appels:</strong> ${task.appelsAgentAssurance.join(' | ') || 'Aucun'}</p>
        <p><strong>WhatsApp:</strong> ${task.whatsAppAgentAssurance.join(' | ') || 'Aucun'}</p>
    `;



    const forfaitInput = document.getElementById('modalMontantForfait');
    if (forfaitInput) forfaitInput.value = task.montantForfait || '';

    document.getElementById('modalNotes').value = task.notes || '';
    document.getElementById('modalPhotoDate').value = task.photoDate || '';
    document.getElementById('modalFactureStatut').value = task.factureStatut || '';
    document.getElementById('modalFactureDate').value = task.factureDate || '';


    if (currentUser.role.toLowerCase() === 'admin' || currentUser.role.toLowerCase() === 'assigner') {
        modalAgentAssign.innerHTML = '';
        agents.filter(a => a.role === 'employee').forEach(emp => {
            const option = new Option(emp.name, emp.name);
            modalAgentAssign.appendChild(option);
        });
        modalAgentAssign.value = task.agent || '';
        agentAssignmentSection.classList.remove('hidden');
    } else {
        agentAssignmentSection.classList.add('hidden');
    }

    const checklist = task.checklist || {};
    const step1Items = ["Carte Grise", "Constat", "Dégâts extérieurs", "Dégâts intérieurs", "Photos roues et au dessous", "Compteur Km", "VIN", "Devis"];
    const step2Items = ["Photos en cours et après réparation"];

    const checklistContainer = document.getElementById('modalChecklist');
    checklistContainer.innerHTML = '';
    step1Items.forEach(key => {
        const item = document.createElement('div');
        const timestamp = checklist[key];
        const isChecked = !!timestamp;
        const formattedDate = isChecked ? `(le ${formatDateTime(timestamp)})` : '';
        const uniqueId = `check-${key.replace(/\s+/g, '-')}`;

        if (key === "Devis") {
            item.className = 'flex flex-col items-start w-full';
            const devisStatus = task.devisStatus || '';
            item.innerHTML = `
                        <div class="flex items-center justify-between w-full">
                            <div class="flex items-center">
                                <input id="${uniqueId}" data-item="${key}" type="checkbox" ${isChecked ? 'checked' : ''} class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <label for="${uniqueId}" class="ml-3 block text-sm text-gray-900">${key}</label>
                            </div>
                            <span class="text-xs text-gray-500">${formattedDate}</span>
                        </div>
                        <div id="devis-reason-container" class="mt-2 pl-7 w-full ${isChecked ? 'hidden' : ''}">
                            <select id="devisStatusSelect" class="w-full p-1 border border-gray-300 rounded-md text-xs">
                                <option value="" ${devisStatus === '' ? 'selected' : ''}>Raison (si non reçu)...</option>
                                <option value="Agent n'a pas encore traité" ${devisStatus === "Agent n'a pas encore traité" ? 'selected' : ''}>Agent n'a pas encore traité</option>
                                <option value="Client n'a pas envoyé" ${devisStatus === "Client n'a pas envoyé" ? 'selected' : ''}>Client n'a pas envoyé</option>
                                <option value="Forfait" ${devisStatus === 'Forfait' ? 'selected' : ''}>Forfait</option>
                            </select>
                        </div>
                        <div id="forfait-amount-container" class="mt-2 pl-7 w-full ${devisStatus !== 'Forfait' ? 'hidden' : ''}">
                           <input type="number" id="modalMontantForfait" class="w-full p-1 border border-gray-300 rounded-md text-xs" placeholder="Montant Forfait (DH)" value="${task.montantForfait || ''}">
                        </div>
                    `;
        } else {
            item.className = 'flex items-center justify-between w-full';
            item.innerHTML = `
                        <div class="flex items-center">
                           <input id="${uniqueId}" data-item="${key}" type="checkbox" ${isChecked ? 'checked' : ''} class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <label for="${uniqueId}" class="ml-3 block text-sm text-gray-900">${key}</label>
                        </div>
                        <span class="text-xs text-gray-500">${formattedDate}</span>
                    `;
        }
        checklistContainer.appendChild(item);
    });

    const devisCheckbox = document.getElementById('check-Devis');
    const devisReasonContainer = document.getElementById('devis-reason-container');
    const forfaitAmountContainer = document.getElementById('forfait-amount-container');
    const devisStatusSelect = document.getElementById('devisStatusSelect');

    if (devisCheckbox && devisReasonContainer && forfaitAmountContainer && devisStatusSelect) {
        devisCheckbox.addEventListener('change', () => {
            devisReasonContainer.classList.toggle('hidden', devisCheckbox.checked);
            if (devisCheckbox.checked) {
                forfaitAmountContainer.classList.add('hidden');
                if (devisStatusSelect.value === 'Forfait') devisStatusSelect.value = '';
            }
        });

        devisStatusSelect.addEventListener('change', () => {
            if (devisStatusSelect.value === 'Forfait') {
                forfaitAmountContainer.classList.remove('hidden');
                if (devisCheckbox) devisCheckbox.checked = true;
                devisReasonContainer.classList.add('hidden');
            } else {
                forfaitAmountContainer.classList.add('hidden');
            }
        });
    }

    const step2ChecklistContainer = document.getElementById('step2Checklist');
    step2ChecklistContainer.innerHTML = '';
    step2Items.forEach(key => {
        const item = document.createElement('div');
        item.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
        const timestamp = checklist[key];
        const isChecked = !!timestamp;
        const formattedDate = isChecked ? `(le ${formatDateTime(timestamp)})` : '';

        item.innerHTML = `
                <div class="flex items-center">
                    <input id="check-${key.replace(/\s+/g, '-')}" data-item="${key}" type="checkbox" ${isChecked ? 'checked' : ''} class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                    <label for="check-${key.replace(/\s+/g, '-')}" class="ml-3 block text-sm font-semibold text-gray-900">${key}</label>
                    <span class="ml-2 text-xs text-gray-500">${formattedDate}</span>
                </div>
                <button type="button" class="upload-step2-btn bg-blue-100 text-blue-700 text-xs font-bold py-1 px-3 rounded-full hover:bg-blue-200">Ajouter Photos</button>
            `;
        step2ChecklistContainer.appendChild(item);
    });

    // Add this block to manage the new report section
    const reportSentSection = document.getElementById('reportSentSection');
    const reportSentCheckbox = document.getElementById('modalReportSent');
    const reportSentDateEl = document.getElementById('reportSentDate');

    if (normalizeString(getCleanedStatus(task.statut)).includes('termine')) {
        reportSentSection.classList.remove('hidden');
        reportSentCheckbox.checked = !!task.rapportEnvoye; // Check the box if a date exists
        reportSentDateEl.textContent = task.rapportEnvoye ? `(le ${new Date(task.rapportEnvoye).toLocaleDateString('fr-FR')})` : '';
    } else {
        reportSentSection.classList.add('hidden');
    }
    updateStepper(task);

    // Add this block
    if (task.statut && task.statut.includes('❌ Annulé')) {
        cancelDossierBtn.classList.add('hidden');
        saveChangesBtn.disabled = true;
    } else {
        cancelDossierBtn.classList.remove('hidden');
        saveChangesBtn.disabled = false;
    }


    fetchTaskActivity(taskId);

    modal.classList.remove('hidden');
    setTimeout(() => {
        modal.classList.remove('opacity-0');
        modalContent.classList.remove('scale-95');
    }, 10);
}

function closeModal() {
    modal.classList.add('opacity-0');
    modalContent.classList.add('scale-95');
    setTimeout(() => {
        modal.classList.add('hidden');
        currentTaskId = null;
    }, 300);
}

// --- IMPORT FUNCTIONS ---
function openImportModal() {
    importFile.value = '';
    importPreview.innerHTML = '<p class="text-center text-gray-500">L\'aperçu des données du fichier apparaîtra ici.</p>';
    importConfirmBtn.disabled = true;
    importStatus.textContent = '';
    importModal.classList.remove('hidden');
    setTimeout(() => {
        importModal.classList.remove('opacity-0');
    }, 10);
}

function closeImportModal() {
    importModal.classList.add('opacity-0');
    setTimeout(() => {
        importModal.classList.add('hidden');
    }, 300);
}

function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, {
            type: 'array',
            cellDates: true
        });
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];
        const json = XLSX.utils.sheet_to_json(worksheet);
        renderImportPreview(json);
    };
    reader.readAsArrayBuffer(file);
}

function renderImportPreview(data) {
    if (data.length === 0) {
        importPreview.innerHTML = '<p class="text-center text-red-500">Aucune donnée trouvée dans le fichier.</p>';
        importConfirmBtn.disabled = true;
        return;
    }

    const existingRefs = new Set(allTasksData.map(t => String(t.ref)));
    const agentAssignments = {}; // To hold counts for each agent in the import

    // First, count assignments for non-duplicate rows
    data.forEach(row => {
        const findKey = (name) => Object.keys(row).find(k => normalizeHeader(k).includes(name));
        const refKey = findKey('ref');
        const ref = refKey ? row[refKey] : null;
        const isDuplicate = ref ? existingRefs.has(String(ref)) : true;

        if (!isDuplicate) {
            const agentName = row[findKey('agent')];
            if (agentName) {
                agentAssignments[agentName] = (agentAssignments[agentName] || 0) + 1;
            }
        }
    });

    const table = document.createElement('table');
    table.id = 'importPreviewTable';
    table.className = 'w-full';

    const headers = ['Importer', 'Ref', 'Assuré', 'Compagnie', 'Agent', 'Matricule', 'Statut'];
    const thead = table.createTHead();
    const headerRow = thead.insertRow();
    const selectAllCell = document.createElement('th');
    selectAllCell.innerHTML = `<input type="checkbox" id="selectAllImport" class="h-4 w-4">`;
    headerRow.appendChild(selectAllCell);

    headers.slice(1).forEach(text => {
        const th = document.createElement('th');
        th.textContent = text;
        headerRow.appendChild(th);
    });

    const tbody = table.createTBody();
    let newRowCount = 0;
    data.forEach((row, index) => {
        const findKey = (name) => Object.keys(row).find(k => normalizeHeader(k).includes(name));
        const refKey = findKey('ref');
        const ref = refKey ? row[refKey] : null;

        const isDuplicate = ref ? existingRefs.has(String(ref)) : true;

        const tr = tbody.insertRow();
        tr.className = isDuplicate ? 'bg-gray-200 text-gray-500' : '';

        const checkCell = tr.insertCell();
        checkCell.innerHTML = `<input type="checkbox" class="import-checkbox h-4 w-4" data-row-index="${index}" ${isDuplicate ? 'disabled' : 'checked'}>`;

        tr.insertCell().textContent = row[findKey('ref')] || 'N/A';
        tr.insertCell().textContent = row[findKey('assur')] || '';
        tr.insertCell().textContent = row[findKey('compagnie')] || '';

        const agentCell = tr.insertCell();
        if (isDuplicate) {
            agentCell.textContent = row[findKey('agent')] || 'N/A';
        } else {
            // Create a dropdown instead of static text
            const agentSelect = document.createElement('select');
            agentSelect.className = 'w-full p-1 border border-gray-300 rounded-md text-xs import-agent-select';

            const placeholderOption = new Option('Non assigné', '');
            agentSelect.add(placeholderOption);

            agents.filter(a => a.role === 'employee').forEach(agent => {
                const option = new Option(agent.name, agent.name);
                agentSelect.add(option);
            });

            const importedAgent = row[findKey('agent')];
            // Check if the agent from the file exists in our list
            if (importedAgent && agents.some(a => a.name === importedAgent)) {
                agentSelect.value = importedAgent;
            }

            agentCell.appendChild(agentSelect);
        }

        tr.insertCell().textContent = row[findKey('matricule')] || '';

        const statusCell = tr.insertCell();
        if (isDuplicate) {
            statusCell.textContent = 'Déjà existant';
        } else {
            statusCell.textContent = 'Prêt à importer';
            newRowCount++;
        }
    });

    importPreview.innerHTML = '';
    importPreview.appendChild(table);
    importConfirmBtn.disabled = newRowCount === 0;

    // Build the status and warning message
    let statusText = `${newRowCount} nouveaux dossiers prêts à être importés.`;
    const warnings = Object.entries(agentAssignments)
        .filter(([agent, count]) => count > 5)
        .map(([agent, count]) => `<span class="font-bold text-red-600">Attention : ${agent} est assigné à ${count} nouveaux dossiers.</span>`);

    if (warnings.length > 0) {
        statusText += '<br>' + warnings.join('<br>');
    }
    importStatus.innerHTML = statusText;

    document.getElementById('selectAllImport').addEventListener('change', (e) => {
        document.querySelectorAll('.import-checkbox:not(:disabled)').forEach(checkbox => {
            checkbox.checked = e.target.checked;
        });
    });
}

async function processImport() {
    const checkboxes = document.querySelectorAll('.import-checkbox:checked:not(:disabled)');
    if (checkboxes.length === 0) {
        showError("Veuillez sélectionner au moins un dossier à importer.");
        return;
    }

    loadingSpinner.classList.remove('hidden');
    importConfirmBtn.disabled = true;

    const file = importFile.files[0];
    const reader = new FileReader();

    reader.onload = async (e) => {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, {
            type: 'array',
            cellDates: true
        });
        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
        const allJsonData = XLSX.utils.sheet_to_json(worksheet);

        const tasksToImport = [];
        checkboxes.forEach(cb => {
            const rowIndex = parseInt(cb.dataset.rowIndex);
            const rowData = allJsonData[rowIndex];

            const task = {};
            const checklist = {};

            const checklistItems = [
                "Carte Grise", "Constat ou récépissé de police", "Dégâts extérieurs",
                "Dégâts intérieurs", "Photos roues et au dessous", "Compteur Km",
                "VIN", "Devis", "Photos en cours et après réparation"
            ];

            for (const key in rowData) {
                const normalizedKey = normalizeHeader(key);
                const isChecklistItem = checklistItems.find(item => normalizeHeader(item) === normalizedKey);

                if (isChecklistItem) {
                    const cleanKey = isChecklistItem === "Constat ou récépissé de police" ? "Constat" : isChecklistItem;
                    checklist[cleanKey] = (String(rowData[key]).toUpperCase() === 'TRUE' || String(rowData[key]) === '1');
                } else {
                    if (normalizedKey.includes('ref')) task.ref = rowData[key];
                    else if (normalizedKey.includes('assur')) task.assure = rowData[key];
                    else if (normalizedKey === 'matricule') task.matricule = rowData[key];
                    else if (normalizedKey.includes('compagnie')) task.compagnie = rowData[key];
                    else if (normalizedKey.includes('datesinistre')) task.dateSinistre = rowData[key];
                    else if (normalizedKey.includes('agent')) task.agent = rowData[key];
                    else if (normalizedKey.includes('marquemodele')) task.marqueModele = rowData[key];
                    else if (normalizedKey.includes('naturedossier')) task.natureDossier = rowData[key];
                    else if (normalizedKey.includes('montantdevis')) task.montantDevis = rowData[key];
                    else if (normalizedKey.includes('devisrectifie')) task.devisRectifie = rowData[key];
                    else if (normalizedKey.includes('montantfacture')) task.montantFacture = rowData[key];
                    else if (normalizedKey.includes('notes') || normalizedKey.includes('commentaires')) task.notes = rowData[key];
                    else if (normalizedKey.includes('datereception')) task.dateReception = rowData[key];
                    else if (normalizedKey.includes('photosenjoursetapresreparationdate')) task.photoDate = rowData[key];
                    else if (normalizedKey.includes('facturestatut')) task.factureStatut = rowData[key];
                    else if (normalizedKey.includes('facturedate')) task.factureDate = rowData[key];
                }
            }
            task.checklist = checklist;

            const agentSelect = document.querySelector(`#importPreviewTable tbody tr:nth-child(${rowIndex + 1}) .import-agent-select`);
            if (agentSelect) {
                task.agent = agentSelect.value;
            } else {
                // Fallback for cases where it might still be text (e.g., if logic changes)
                const agentKey = Object.keys(rowData).find(k => normalizeHeader(k).includes('agent'));
                if (agentKey) {
                    task.agent = rowData[agentKey];
                }
            }

            if (task.ref && task.assure) tasksToImport.push(task);
        });

        try {
            const response = await fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                mode: 'cors',
                headers: {
                    'Content-Type': 'text/plain;charset=utf-8'
                },
                body: JSON.stringify({
                    action: 'importTasks',
                    data: tasksToImport
                })
            });
            const result = await response.json();
            if (result.status !== 'success') throw new Error(result.message);

            closeImportModal();
            await fetchTasks();
        } catch (error) {
            showError(`Erreur lors de l'importation: ${error.message}`);
        } finally {
            loadingSpinner.classList.add('hidden');
            importConfirmBtn.disabled = false;
        }
    };
    reader.readAsArrayBuffer(file);
}

// --- NOTIFICATION FUNCTIONS ---
async function fetchNotifications() {
    if (!currentUser) return;
    try {
        const response = await fetch(`${APPS_SCRIPT_URL}?action=getNotifications&userId=${currentUser.name}`);
        const data = await response.json();
        if (data.error) throw new Error(data.error);
        notifications = data;
        renderNotifications();
    } catch (error) {
        console.error("Error fetching notifications:", error);
    }
}

function renderNotifications() {
    const unreadCount = notifications.filter(n => !n.IsRead).length;
    if (unreadCount > 0) {
        notificationCount.textContent = unreadCount;
        notificationCount.classList.remove('hidden');
    } else {
        notificationCount.classList.add('hidden');
    }

    notificationList.innerHTML = '';
    if (notifications.length === 0) {
        notificationList.innerHTML = '<p class="text-center text-gray-500 p-4">Aucune notification</p>';
        return;
    }

    notifications.forEach(n => {
        const item = document.createElement('div');
        item.className = `p-3 border-b border-gray-100 cursor-pointer hover:bg-gray-50 ${!n.IsRead ? 'bg-blue-50' : ''}`;
        item.dataset.taskId = n.RelatedTaskID;
        item.innerHTML = `
                <p class="text-sm text-gray-800">${n.Message}</p>
                <p class="text-xs text-gray-500 mt-1">${new Date(n.Timestamp).toLocaleString('fr-FR')}</p>
            `;
        item.addEventListener('click', () => handleNotificationClick(n.RelatedTaskID));
        notificationList.appendChild(item);
    });
}

async function markNotificationsRead() {
    const unreadIds = notifications.filter(n => !n.IsRead).map(n => n.ID);
    if (unreadIds.length === 0) return;

    notifications.forEach(n => {
        if (!n.IsRead) n.IsRead = true;
    });
    renderNotifications();

    try {
        await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'cors',
            headers: {
                'Content-Type': 'text/plain;charset=utf-8'
            },
            body: JSON.stringify({
                action: 'markNotificationsRead',
                ids: unreadIds
            })
        });
    } catch (error) {
        console.error("Failed to mark notifications as read:", error);
    }
}

function handleNotificationClick(taskId) {
    notificationPanel.classList.add('hidden', 'opacity-0');
    if (taskId) {
        openModal(taskId);
    }
}

// --- MODAL ACTIVITY/FILE FUNCTIONS ---

function switchModalTab(tabName) {
    detailsContent.classList.add('hidden');
    activityContent.classList.add('hidden');
    filesContent.classList.add('hidden');
    commContent.classList.add('hidden'); // Add this
    detailsFooter.classList.add('hidden');

    tabDetails.classList.remove('active');
    tabActivity.classList.remove('active');
    tabFiles.classList.remove('active');
    tabComm.classList.remove('active'); // Add this


    if (tabName === 'details') {
        detailsContent.classList.remove('hidden');
        detailsFooter.classList.remove('hidden');
        tabDetails.classList.add('active');
    } else if (tabName === 'activity') {
        activityContent.classList.remove('hidden');
        tabActivity.classList.add('active');
    } else if (tabName === 'files') {
        filesContent.classList.remove('hidden');
        tabFiles.classList.add('active');

    } else if (tabName === 'comm') { // Add this whole block
        commContent.classList.remove('hidden');
        tabComm.classList.add('active');
    }
}

async function fetchTaskActivity(taskId) {
    activityLog.innerHTML = '<p>Chargement...</p>';
    fileList.innerHTML = '<p>Chargement...</p>';
    try {
        const response = await fetch(`${APPS_SCRIPT_URL}?action=getTaskActivity&taskId=${taskId}`);
        const data = await response.json();
        if (data.error) throw new Error(data.error);
        renderActivityLog(data.logs);
        renderFiles(data.files);
    } catch (error) {
        activityLog.innerHTML = `<p class="text-red-500">Erreur de chargement de l'activité.</p>`;
        fileList.innerHTML = `<p class="text-red-500">Erreur de chargement des fichiers.</p>`;
        console.error("Error fetching task activity:", error);
    }
}

function renderActivityLog(logs) {
    activityLog.innerHTML = '';
    if (!logs || logs.length === 0) {
        activityLog.innerHTML = '<p class="text-center text-gray-500 p-4">Aucune activité enregistrée.</p>';
        return;
    }
    logs.forEach(log => {
        const logElement = document.createElement('div');
        logElement.className = 'text-sm pb-4 border-b';
        logElement.innerHTML = `
                <p><span class="font-bold">${log.User}</span> ${log.Action}</p>
                ${log.Details ? `<p class="pl-4 text-gray-600 bg-gray-50 p-2 mt-1 rounded">${log.Details}</p>` : ''}
                <p class="text-xs text-gray-400 mt-1">${new Date(log.Timestamp).toLocaleString('fr-FR')}</p>
            `;
        activityLog.appendChild(logElement);
    });
}

function renderFiles(files) {
    fileList.innerHTML = '';
    if (!files || files.length === 0) {
        fileList.innerHTML = '<p class="text-center text-gray-500 p-4">Aucun fichier ajouté.</p>';
        return;
    }
    files.forEach(file => {
        const fileElement = document.createElement('a');
        fileElement.href = file.FileURL;
        fileElement.target = '_blank';
        fileElement.className = 'block p-2 border rounded-lg hover:bg-gray-100';
        fileElement.innerHTML = `
                <p class="font-semibold text-blue-600">${file.FileName}</p>
                <p class="text-xs text-gray-500">Ajouté par ${file.UploadedBy} le ${new Date(file.Timestamp).toLocaleDateString('fr-FR')}</p>
            `;
        fileList.appendChild(fileElement);
    });
}

async function addComment() {
    const commentText = commentInput.value.trim();
    if (!commentText || !currentTaskId) return;

    loadingSpinner.classList.remove('hidden');
    try {
        const response = await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'cors',
            headers: {
                'Content-Type': 'text/plain;charset=utf-8'
            },
            body: JSON.stringify({
                action: 'addComment',
                taskId: currentTaskId,
                user: currentUser.name,
                comment: commentText
            })
        });
        const result = await response.json();
        if (result.status !== 'success') throw new Error(result.message);
        commentInput.value = '';
        fetchTaskActivity(currentTaskId);
    } catch (error) {
        showError("Erreur lors de l'ajout du commentaire.");
        console.error(error);
    } finally {
        loadingSpinner.classList.add('hidden');
    }
}

function handleFileUpload(event) {
    const files = event.target.files;
    if (files.length === 0 || !currentTaskId) return;

    loadingSpinner.classList.remove('hidden');

    for (let i = 0; i < files.length; i++) {
        const reader = new FileReader();
        const file = files[i];
        reader.readAsDataURL(file);
        reader.onload = async () => {
            const base64Data = reader.result.split(',')[1];
            const fileData = {
                action: 'uploadFile',
                taskId: currentTaskId,
                user: currentUser.name,
                fileName: file.name,
                mimeType: file.type,
                data: base64Data
            };

            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8'
                    },
                    body: JSON.stringify(fileData)
                });
                const result = await response.json();
                if (result.status !== 'success') throw new Error(result.message);

                if (i === files.length - 1) {
                    fileUploadInput.value = '';
                    fetchTaskActivity(currentTaskId);
                }
            } catch (error) {
                showError(`Erreur lors du téléversement de ${file.name}.`);
                console.error(error);
            } finally {
                if (i === files.length - 1) {
                    loadingSpinner.classList.add('hidden');
                }
            }
        };
    }
}

function updateStepper(task) {
    const step1 = document.getElementById('step-1');
    const step2 = document.getElementById('step-2');
    const step3 = document.getElementById('step-3');
    const step1Header = document.getElementById('step1Header');
    const step2Header = document.getElementById('step2Header');
    const receptionDate = task.dateReception ? new Date(task.dateReception) : null;

    [step1, step2, step3].forEach(el => el.className = 'step');

    const isStep1Complete = task.step1CompletionDate != null;
    const isStep2Complete = task.checklist['Photos en cours et après réparation'];
    const isTermine = normalizeString(getCleanedStatus(task.statut)).includes('termine');

    let step1DeadlineText = '';
    let step2DeadlineText = '';

    if (receptionDate) {
        const deadline3d = new Date(receptionDate);
        deadline3d.setDate(deadline3d.getDate() + 3);
        step1DeadlineText = `(Deadline: ${deadline3d.toLocaleDateString('fr-FR')})`;
    }

    if (isStep1Complete) {
        const step1Date = new Date(task.step1CompletionDate);
        const deadline21d = new Date(step1Date);
        deadline21d.setDate(step1Date.getDate() + 21);
        step2DeadlineText = `(Deadline: ${deadline21d.toLocaleDateString('fr-FR')})`;
    }

    step1Header.innerHTML = `Étape 1: Documents & Devis <span class="text-sm font-normal text-red-600">${step1DeadlineText}</span>`;
    step2Header.innerHTML = `Étape 2: Réparation & Clôture <span class="text-sm font-normal text-red-600">${step2DeadlineText}</span>`;


    if (isTermine) {
        step1.classList.add('completed');
        step2.classList.add('completed');
        step3.classList.add('completed');
    } else if (isStep2Complete) {
        step1.classList.add('completed');
        step2.classList.add('completed');
        step3.classList.add('active');
    } else if (isStep1Complete) {
        step1.classList.add('completed');
        step2.classList.add('active');
    } else {
        step1.classList.add('active');
    }
}
async function logCommunication(type, target) {
    loadingSpinner.classList.remove('hidden');
    try {
        const response = await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'cors',
            headers: {
                'Content-Type': 'text/plain;charset=utf-8'
            },
            body: JSON.stringify({
                action: 'logCommunication',
                taskId: currentTaskId,
                userName: currentUser.name,
                type: type, // 'call' or 'whatsapp'
                target: target // 'client' or 'insurance_agent'
            })
        });
        const result = await response.json();
        if (result.status !== 'success') throw new Error(result.message);

        // Refresh the task data locally to show the new log instantly
        const taskIndex = allTasksData.findIndex(t => t.id === currentTaskId);
        if (taskIndex !== -1) {
            const logKey = `${type === 'call' ? 'appels' : 'whatsApp'}${target === 'client' ? 'Assure' : 'AgentAssurance'}`;
            allTasksData[taskIndex][logKey] = result.newLog;
            openModal(currentTaskId); // Re-open/refresh the modal to show the new log
        }
    } catch (error) {
        showError(`Erreur lors de l'enregistrement du contact: ${error.message}`);
    } finally {
        loadingSpinner.classList.add('hidden');
    }
}

// --- ADMIN PAGE FUNCTIONS ---
function renderAdminPage() {
    agentsTableBody.innerHTML = '';
    if (!agents || agents.length === 0) {
        agentsTableBody.innerHTML = '<tr><td colspan="4" class="text-center p-4">Aucun agent trouvé.</td></tr>';
        return;
    }

    agents.forEach(agent => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
                <td class="p-4 align-top">${agent.name}</td>
                <td class="p-4 align-top">${agent.email}</td>
                <td class="p-4 align-top capitalize">${agent.role}</td>
                <td class="p-4 align-top">
                    <div class="flex space-x-2">
                        <button class="edit-agent-btn text-blue-600 hover:text-blue-800" data-email="${agent.email}">Modifier</button>
                        <button class="delete-agent-btn text-red-600 hover:text-red-800" data-email="${agent.email}">Supprimer</button>
                    </div>
                </td>
            `;
        agentsTableBody.appendChild(tr);
    });
}

function openAgentModal(agent = null) {
    agentForm.reset();
    const agentModalTitle = document.getElementById('agentModalTitle');
    const agentEmailInput = document.getElementById('agentEmail');
    const agentOriginalEmail = document.getElementById('agentOriginalEmail');
    const agentPasswordInput = document.getElementById('agentPassword');

    if (agent) {
        agentModalTitle.textContent = 'Modifier un Agent';
        document.getElementById('agentName').value = agent.name;
        agentEmailInput.value = agent.email;
        agentOriginalEmail.value = agent.email;
        document.getElementById('agentRole').value = agent.role;
        agentPasswordInput.placeholder = 'Laisser vide pour ne pas changer';
        agentEmailInput.disabled = true;
    } else {
        agentModalTitle.textContent = 'Nouvel Agent';
        agentPasswordInput.placeholder = 'Mot de passe';
        agentPasswordInput.required = true;
        agentEmailInput.disabled = false;
        agentOriginalEmail.value = '';
    }

    agentModal.classList.remove('hidden');
    setTimeout(() => agentModal.classList.remove('opacity-0'), 10);
}

function closeAgentModal() {
    agentModal.classList.add('opacity-0');
    setTimeout(() => agentModal.classList.add('hidden'), 300);
}

async function handleAgentFormSubmit(e) {
    e.preventDefault();
    loadingSpinner.classList.remove('hidden');

    const originalEmail = document.getElementById('agentOriginalEmail').value;
    const isEditMode = !!originalEmail;

    const payload = {
        action: isEditMode ? 'updateAgent' : 'addAgent',
        originalEmail: originalEmail,
        name: document.getElementById('agentName').value,
        email: document.getElementById('agentEmail').value,
        password: document.getElementById('agentPassword').value,
        role: document.getElementById('agentRole').value
    };

    if (isEditMode && !payload.password) {
        delete payload.password;
    }

    try {
        const response = await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'cors',
            headers: {
                'Content-Type': 'text/plain;charset=utf-8'
            },
            body: JSON.stringify(payload)
        });
        const result = await response.json();
        if (result.status !== 'success') throw new Error(result.message);

        closeAgentModal();
        await fetchAgents();
        renderAdminPage();

    } catch (error) {
        showError(`Erreur lors de la sauvegarde de l'agent: ${error.message}`);
    } finally {
        loadingSpinner.classList.add('hidden');
    }
}

async function deleteAgent(email) {
    loadingSpinner.classList.remove('hidden');
    try {
        const response = await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'cors',
            headers: {
                'Content-Type': 'text/plain;charset=utf-8'
            },
            body: JSON.stringify({
                action: 'deleteAgent',
                email: email
            })
        });
        const result = await response.json();
        if (result.status !== 'success') throw new Error(result.message);

        await fetchAgents();
        renderAdminPage();
    } catch (error) {
        showError(`Erreur lors de la suppression de l'agent: ${error.message}`);
    } finally {
        loadingSpinner.classList.add('hidden');
    }
}

// --- PROFILE MODAL FUNCTIONS ---

function openProfileModal() {
    if (!currentUser) return;
    document.getElementById('profileName').value = currentUser.name;
    document.getElementById('profileEmail').value = currentUser.email;
    document.getElementById('profilePassword').value = '';

    const profilePicPreview = document.getElementById('profilePicturePreview');
    if (currentUser.profilepictureurl) {
        profilePicPreview.src = currentUser.profilepictureurl;
    } else {
        profilePicPreview.src = 'https://placehold.co/100x100';
    }

    profileModal.classList.remove('hidden');
    setTimeout(() => profileModal.classList.remove('opacity-0'), 10);
}

function closeProfileModal() {
    profileModal.classList.add('opacity-0');
    setTimeout(() => profileModal.classList.add('hidden'), 300);
}

async function handleProfileFormSubmit(e) {
    e.preventDefault();

    const pictureFile = profilePictureInput.files[0];

    const payload = {
        action: 'updateProfile',
        email: currentUser.email,
        name: document.getElementById('profileName').value,
        password: document.getElementById('profilePassword').value
    };

    if (!payload.password) delete payload.password;

    if (pictureFile) {
        loadingSpinner.classList.remove('hidden');
        const reader = new FileReader();
        reader.readAsDataURL(pictureFile);
        reader.onload = async () => {
            const base64Data = reader.result.split(',')[1];
            payload.pictureData = base64Data;
            payload.pictureFileName = pictureFile.name;
            payload.mimeType = pictureFile.type;
            sendProfileUpdate(payload);
        };
        reader.onerror = () => {
            showError("Erreur de lecture du fichier image.");
            loadingSpinner.classList.add('hidden');
        };
    } else {
        sendProfileUpdate(payload);
    }
}

async function sendProfileUpdate(payload) {
    loadingSpinner.classList.remove('hidden');
    try {
        const response = await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'cors',
            headers: {
                'Content-Type': 'text/plain;charset=utf-8'
            },
            body: JSON.stringify(payload)
        });
        const result = await response.json();
        if (result.status !== 'success') throw new Error(result.message);

        currentUser.name = payload.name;
        document.getElementById('userName').textContent = currentUser.name;
        if (payload.password) currentUser.password = payload.password;
        if (result.newImageUrl) {
            currentUser.profilepictureurl = result.newImageUrl;
            document.getElementById('headerProfilePicture').src = result.newImageUrl;
        }

        closeProfileModal();
        await fetchAgents();
    } catch (error) {
        showError(`Erreur lors de la mise à jour du profil: ${error.message}`);
    } finally {
        loadingSpinner.classList.add('hidden');
    }
}

// --- Advanced Task (Kanban) Functions ---

// --- Advanced Task (Kanban) Functions ---

async function fetchAdvancedTasks() {
    if (!currentUser) return;
    try {
        const response = await fetch(`${APPS_SCRIPT_URL}?action=getAdvancedTasks&userEmail=${currentUser.email}&userRole=${currentUser.role}`);
        const data = await response.json();
        if (data.error) throw new Error(data.error);
        advancedTasks = data;
        renderAdvancedTasks();
    } catch (error) {
        showError(`Erreur lors du chargement des tâches : ${error.message}`);
    }
}

function renderAdvancedTasks() {
    const todoCol = document.getElementById('todo-col');
    const inprogressCol = document.getElementById('inprogress-col');
    const doneCol = document.getElementById('done-col');
    [todoCol, inprogressCol, doneCol].forEach(col => col.innerHTML = '');

    // Populate assignee filter
    const allAssignees = [...new Set(agents.map(agent => agent.name).filter(Boolean))].sort();
    advancedTaskAssigneeFilter.innerHTML = '<option value="all">Tous les agents</option>';
    allAssignees.forEach(assignee => {
        const option = new Option(assignee, assignee);
        advancedTaskAssigneeFilter.appendChild(option);
    });

    // Get filter values
    const searchTerm = advancedTaskSearch.value.toLowerCase();
    const selectedAssignee = advancedTaskAssigneeFilter.value;
    const selectedPriority = advancedTaskPriorityFilter.value;
    const showUrgentOnly = urgentFilter.checked;
    const sevenDaysFromNow = new Date();
    sevenDaysFromNow.setDate(sevenDaysFromNow.getDate() + 7);

    // Filter tasks
    const filteredTasks = advancedTasks.filter(task => {
        const matchesSearch = task.Title.toLowerCase().includes(searchTerm);
        const matchesAssignee = selectedAssignee === 'all' || task.Assignee === selectedAssignee;
        const matchesPriority = selectedPriority === 'all' || task.Priority === selectedPriority;
        const deadline = task.Deadline ? new Date(task.Deadline) : null;
        const matchesUrgent = !showUrgentOnly || (deadline && deadline <= sevenDaysFromNow);
        return matchesSearch && matchesAssignee && matchesPriority && matchesUrgent;
    });

    let todo = 0, inprogress = 0, done = 0;

    // Render tasks into columns
    filteredTasks.forEach(task => {
        const taskEl = createAdvancedTaskElement(task);
        if (task.Status === 'En Cours') {
            inprogressCol.appendChild(taskEl);
            inprogress++;
        } else if (task.Status === 'Terminé') {
            doneCol.appendChild(taskEl);
            done++;
        } else {
            todoCol.appendChild(taskEl);
            todo++;
        }
    });

    // Update counts
    todoCount.textContent = todo;
    inprogressCount.textContent = inprogress;
    doneCount.textContent = done;
}

function createAdvancedTaskElement(task) {
    const div = document.createElement('div');
    div.className = 'kanban-task bg-white p-4 rounded-lg shadow-sm border border-gray-200 cursor-grab';
    div.draggable = true;
    div.dataset.id = task.ID;

    // --- FIX IS HERE: Define linkedDossier ONCE at the top ---
    const linkedDossier = allTasksData.find(d => d.id === task.DossierID);
    const isTimerActive = linkedDossier ? linkedDossier.isTimerActive : false;
    const isInitialOverdue = linkedDossier ? linkedDossier.isInitialTaskOverdue : false;
    const receptionDate = linkedDossier ? linkedDossier.dateReception : null;
    const initialOverdueBadge = isInitialOverdue ? `<span class="text-xs font-bold text-red-700 bg-red-100 px-2 py-1 rounded-full">EN RETARD</span>` : '';
    // --- End of fix ---

    const priorityClasses = { 'Haute': 'bg-red-500', 'Moyenne': 'bg-yellow-500', 'Basse': 'bg-green-500' };
    const priorityColor = priorityClasses[task.Priority] || 'bg-gray-400';

    const deadline = task.Deadline ? new Date(task.Deadline) : null;
    const isOverdue = deadline && new Date() > deadline && task.Status !== 'Terminé';
    const subtasks = task.Subtasks || [];
    const completedSubtasks = subtasks.filter(st => st.completed).length;
    const subtaskProgress = subtasks.length > 0 ? (completedSubtasks / subtasks.length) * 100 : 0;
    const agent = agents.find(a => a.name === task.Assignee);
    const agentImg = agent?.profilepictureurl || 'https://placehold.co/40x40';

    div.innerHTML = `
        <div class="flex justify-between items-start mb-2">
            <h3 class="font-bold text-base text-gray-800 flex items-center gap-2">${task.Title} ${initialOverdueBadge}</h3>
            <img src="${agentImg}" alt="${task.Assignee}" class="w-8 h-8 rounded-full object-cover border-2 border-white ring-1 ring-gray-200" title="${task.Assignee || 'Non assigné'}">
        </div>
        <p class="text-sm text-gray-600 mb-3">${task.Description || ''}</p>
        
        ${isTimerActive ? `
        <div class="countdown-timer flex items-center justify-center gap-1.5 text-sm font-bold p-1.5 rounded-md mb-3" data-reception-date="${receptionDate}">
        </div>` : ''}

        ${subtasks.length > 0 ? `
        <div class="mb-3">
            <div class="flex justify-between items-center mb-1">
                <span class="text-xs font-semibold text-gray-500">Sous-tâches</span>
                <span class="text-xs text-gray-500">${completedSubtasks}/${subtasks.length}</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-1.5"><div class="bg-blue-600 h-1.5 rounded-full" style="width: ${subtaskProgress}%"></div></div>
        </div>` : ''}

        <div class="text-xs text-gray-500 border-t pt-3 mt-3 flex justify-between items-center">
            <span class="flex items-center gap-1 ${isOverdue ? 'text-red-600 font-bold' : ''}">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                ${deadline ? deadline.toLocaleDateString('fr-FR') : 'Pas de date'}
            </span>
            <span class="w-16 h-1.5 rounded-full ${priorityColor}" title="Priorité: ${task.Priority}"></span>
        </div>
    `;

    div.addEventListener('click', () => openAdvancedTaskModal(task));
    div.addEventListener('dragstart', (e) => { e.dataTransfer.setData('text/plain', task.ID); e.target.classList.add('dragging'); });
    div.addEventListener('dragend', (e) => { e.target.classList.remove('dragging'); });
    return div;
}

function setupDragAndDrop() {
    const columns = document.querySelectorAll('.task-column');
    columns.forEach(col => {
        col.addEventListener('dragover', e => {
            e.preventDefault();
        });
        col.addEventListener('drop', e => {
            e.preventDefault();
            const taskId = e.dataTransfer.getData('text/plain');
            const newStatus = col.id === 'todo-col' ? 'À Faire' : (col.id === 'inprogress-col' ? 'En Cours' : 'Terminé');

            const draggedElement = document.querySelector(`.kanban-task[data-id='${taskId}']`);
            if (draggedElement) {
                col.appendChild(draggedElement);
                updateAdvancedTaskStatus(taskId, newStatus);
            }
        });
    });
}

async function addOrUpdateAdvancedTask(taskData) {
    loadingSpinner.classList.remove('hidden');
    try {
        const response = await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'cors',
            headers: {
                'Content-Type': 'text/plain;charset=utf-8'
            },
            body: JSON.stringify({
                action: 'addOrUpdateAdvancedTask',
                ...taskData
            })
        });
        const result = await response.json();
        if (result.status !== 'success') throw new Error(result.message);

        await fetchAdvancedTasks();
        closeAdvancedTaskModal();

    } catch (error) {
        showError(`Erreur lors de la sauvegarde: ${error.message}`);
    } finally {
        loadingSpinner.classList.add('hidden');
    }
}

async function updateAdvancedTaskStatus(id, status) {
    const task = advancedTasks.find(t => t.ID === id);
    if (task) task.Status = status;

    try {
        await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'cors',
            headers: {
                'Content-Type': 'text/plain;charset=utf-8'
            },
            body: JSON.stringify({
                action: 'updateAdvancedTaskStatus',
                id,
                status
            })
        });
    } catch (error) {
        showError(`Erreur de mise à jour du statut.`);
        fetchAdvancedTasks(); // Re-fetch to correct the UI on error
    }
}

async function deleteAdvancedTask(id) {
    loadingSpinner.classList.remove('hidden');
    try {
        await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'cors',
            headers: {
                'Content-Type': 'text/plain;charset=utf-8'
            },
            body: JSON.stringify({
                action: 'deleteAdvancedTask',
                id
            })
        });
        await fetchAdvancedTasks();
        closeAdvancedTaskModal();
    } catch (error) {
        showError(`Erreur de suppression de la tâche.`);
    } finally {
        loadingSpinner.classList.add('hidden');
    }
}

function openAdvancedTaskModal(task = null) {
    advancedTaskForm.reset();
    const modalTitle = document.getElementById('advancedTaskModalTitle');
    const taskIdInput = document.getElementById('advancedTaskId');
    const deleteBtn = document.getElementById('deleteAdvancedTaskBtn');
    const assigneeSelect = document.getElementById('taskAssignee');
    const subtaskList = document.getElementById('subtaskList');
    subtaskList.innerHTML = '';

    assigneeSelect.innerHTML = '<option value="">Non assigné</option>';
    agents.forEach(agent => {
        const option = new Option(agent.name, agent.name);
        assigneeSelect.appendChild(option);
    });
    
    const renderSubtask = (subtask, index) => {
        const subtaskEl = document.createElement('div');
        subtaskEl.className = 'flex items-center justify-between bg-gray-100 p-2 rounded-md';
        subtaskEl.innerHTML = `
            <div class="flex items-center">
                <input type="checkbox" data-index="${index}" class="h-4 w-4 rounded border-gray-300 text-blue-600 subtask-checkbox" ${subtask.completed ? 'checked' : ''}>
                <label class="ml-2 text-sm text-gray-800 ${subtask.completed ? 'line-through text-gray-500' : ''}">${subtask.title}</label>
            </div>
            <button type="button" data-index="${index}" class="remove-subtask-btn text-gray-400 hover:text-red-600">&times;</button>
        `;
        subtaskList.appendChild(subtaskEl);
    };

    if (task) {
        modalTitle.textContent = "Modifier la Tâche";
        taskIdInput.value = task.ID;
        document.getElementById('taskTitle').value = task.Title;
        document.getElementById('taskDescription').value = task.Description || '';
        assigneeSelect.value = task.Assignee || '';
        document.getElementById('taskDeadline').value = task.Deadline ? task.Deadline.slice(0, 16) : '';
        document.getElementById('taskPriority').value = task.Priority || 'Moyenne';
        document.getElementById('taskStatus').value = task.Status || 'À Faire';
        (task.Subtasks || []).forEach(renderSubtask);
        deleteBtn.classList.remove('hidden');
    } else {
        modalTitle.textContent = "Nouvelle Tâche";
        taskIdInput.value = '';
        deleteBtn.classList.add('hidden');
    }
    
    advancedTaskModal.classList.remove('hidden');
    setTimeout(() => {
        advancedTaskModal.classList.remove('opacity-0');
        advancedTaskModalContent.classList.remove('scale-95');
    }, 10);
}

async function handleAdvancedTaskFormSubmit(e) {
    e.preventDefault();
    const subtaskNodes = document.querySelectorAll('#subtaskList > div');
    const subtasks = Array.from(subtaskNodes).map((node, index) => ({
        title: node.querySelector('label').textContent,
        completed: node.querySelector('input[type="checkbox"]').checked
    }));

    const taskData = {
        id: document.getElementById('advancedTaskId').value,
        title: document.getElementById('taskTitle').value,
        description: document.getElementById('taskDescription').value,
        assignee: document.getElementById('taskAssignee').value,
        deadline: document.getElementById('taskDeadline').value,
        priority: document.getElementById('taskPriority').value,
        status: document.getElementById('taskStatus').value,
        userEmail: currentUser.email,
        subtasks: subtasks
    };
    await addOrUpdateAdvancedTask(taskData);
}

// --- CALENDAR FUNCTIONS ---
function renderCalendar(year, month) {
    calendarGrid.innerHTML = '';
    monthYearEl.textContent = new Date(year, month).toLocaleDateString('fr-FR', {
        month: 'long',
        year: 'numeric'
    });

    const selectedAgent = calendarAgentFilter.value; // Read the filter value

    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);

    let startingDay = firstDay.getDay() - 1;
    if (startingDay < 0) startingDay = 6;

    for (let i = 0; i < startingDay; i++) {
        const emptyCell = document.createElement('div');
        emptyCell.className = 'calendar-day border-t border-l p-2 day-other-month';
        calendarGrid.appendChild(emptyCell);
    }

    for (let day = 1; day <= lastDay.getDate(); day++) {
        const dayCell = document.createElement('div');
        const currentDate = new Date(year, month, day);
        const isToday = currentDate.toDateString() === new Date().toDateString();

        dayCell.className = `calendar-day border-t border-l p-2 relative ${isToday ? 'bg-blue-50' : ''}`;
        dayCell.innerHTML = `<div class="text-sm font-semibold ${isToday ? 'text-blue-600' : ''}">${day}</div><div class="mt-1 space-y-1"></div>`;

        const eventsContainer = dayCell.querySelector('div:last-child');

        // Filter Dossiers by agent
        allTasksData.filter(task => (selectedAgent === 'all' || task.agent === selectedAgent) && task.dateLimite && new Date(task.dateLimite).toDateString() === currentDate.toDateString())
            .forEach(task => {
                const eventEl = document.createElement('div');
                eventEl.className = 'calendar-task event-dossier';
                eventEl.textContent = `Dossier: ${task.ref}`;
                eventEl.dataset.taskId = task.id;
                eventsContainer.appendChild(eventEl);
            });

        // Filter Tâches by agent
        advancedTasks.filter(task => (selectedAgent === 'all' || task.Assignee === selectedAgent) && task.Deadline && new Date(task.Deadline).toDateString() === currentDate.toDateString())
            .forEach(task => {
                const eventEl = document.createElement('div');
                eventEl.className = 'calendar-task event-task';
                eventEl.textContent = `Tâche: ${task.Title}`;
                eventEl.dataset.advancedTaskId = task.ID;
                eventsContainer.appendChild(eventEl);
            });

        // Filter Calendar Events by agent (Holidays always show)
        calendarEvents.forEach(event => {
            const startDate = new Date(event.StartDate);
            const endDate = new Date(event.EndDate);
            const isHoliday = event.Type === 'Férié';
            const isRelevantVacation = event.Type === 'Vacances' && (selectedAgent === 'all' || event.UserID === selectedAgent);

            if ((isHoliday || isRelevantVacation) && currentDate >= startDate && currentDate <= endDate) {
                const eventEl = document.createElement('div');
                const eventClass = event.Type === 'Vacances' ? 'event-vacation' : 'event-holiday';
                eventEl.className = `calendar-task ${eventClass}`;
                eventEl.textContent = `${event.Title} (${event.UserID === 'all' ? 'Tous' : event.UserID})`;
                eventEl.dataset.eventId = event.ID;
                eventsContainer.appendChild(eventEl);
            }
        });

        calendarGrid.appendChild(dayCell);
    }
}

function openEventModal(event = null) {
    eventForm.reset();
    const modalTitle = document.getElementById('eventModalTitle');
    const eventIdInput = document.getElementById('eventId');
    const deleteBtn = document.getElementById('deleteEventBtn');
    const userSelect = document.getElementById('eventUser');

    userSelect.innerHTML = '<option value="all">Tous (Férié)</option>';
    agents.filter(a => a.role === 'employee').forEach(emp => {
        userSelect.appendChild(new Option(emp.name, emp.name));
    });

    if (event) {
        modalTitle.textContent = "Modifier l'événement";
        eventIdInput.value = event.ID;
        document.getElementById('eventTitle').value = event.Title;
        document.getElementById('eventStartDate').value = event.StartDate.split('T')[0];
        document.getElementById('eventEndDate').value = event.EndDate.split('T')[0];
        document.getElementById('eventType').value = event.Type;
        userSelect.value = event.UserID;
        deleteBtn.classList.remove('hidden');
    } else {
        modalTitle.textContent = "Ajouter un événement";
        eventIdInput.value = '';
        deleteBtn.classList.add('hidden');
    }

    eventModal.classList.remove('hidden');
    setTimeout(() => eventModal.classList.remove('opacity-0'), 10);
}

function closeEventModal() {
    eventModal.classList.add('opacity-0');
    setTimeout(() => eventModal.classList.add('hidden'), 300);
}

async function handleEventFormSubmit(e) {
    e.preventDefault();
    const payload = {
        action: 'addOrUpdateCalendarEvent',
        id: document.getElementById('eventId').value,
        title: document.getElementById('eventTitle').value,
        startDate: document.getElementById('eventStartDate').value,
        endDate: document.getElementById('eventEndDate').value,
        type: document.getElementById('eventType').value,
        userId: document.getElementById('eventUser').value
    };

    if (new Date(payload.endDate) < new Date(payload.startDate)) {
        showError("La date de fin ne peut pas être antérieure à la date de début.");
        return;
    }

    loadingSpinner.classList.remove('hidden');
    try {
        const response = await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'cors',
            headers: {
                'Content-Type': 'text/plain;charset=utf-8'
            },
            body: JSON.stringify(payload)
        });
        const result = await response.json();
        if (result.status !== 'success') throw new Error(result.message);

        await fetchCalendarEvents();
        renderCalendar(calendarDate.getFullYear(), calendarDate.getMonth());
        closeEventModal();
    } catch (error) {
        showError(`Erreur: ${error.message}`);
    } finally {
        loadingSpinner.classList.add('hidden');
    }
}

async function deleteCalendarEvent(id) {
    loadingSpinner.classList.remove('hidden');
    try {
        const response = await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'cors',
            headers: {
                'Content-Type': 'text/plain;charset=utf-8'
            },
            body: JSON.stringify({
                action: 'deleteCalendarEvent',
                id: id
            })
        });
        const result = await response.json();
        if (result.status !== 'success') throw new Error(result.message);

        await fetchCalendarEvents();
        renderCalendar(calendarDate.getFullYear(), calendarDate.getMonth());
        closeEventModal();
    } catch (error) {
        showError(`Erreur: ${error.message}`);
    } finally {
        loadingSpinner.classList.add('hidden');
    }
}

// --- EVENT LISTENERS ---

function toggleSidebar() {
    sidebar.classList.toggle('-translate-x-full');
    sidebar.classList.toggle('translate-x-0');
    sidebarOverlay.classList.toggle('hidden');
}

mobileMenuBtn.addEventListener('click', toggleSidebar);
sidebarOverlay.addEventListener('click', toggleSidebar);

mainNav.addEventListener('click', (e) => {
    const link = e.target.closest('.sidebar-nav-link');
    if (link) {
        e.preventDefault();
        // Close sidebar on mobile after click
        if (window.innerWidth < 768 && !sidebar.classList.contains('-translate-x-full')) {
            toggleSidebar();
        }

        if (link.id === 'navDashboard') showPage('dashboardPage');
        else if (link.id === 'navDossiers') showPage('dossiersPage');
        else if (link.id === 'navAdvancedTasks') showPage('advancedTasksPage');
        else if (link.id === 'navCalendar') showPage('calendarPage');
        else if (link.id === 'navProductivity') showPage('productivityPage');
        else if (link.id === 'navStats') showPage('statsPage');
        else if (link.id === 'navFacturation') showPage('facturationPage'); // Add this line
        else if (link.id === 'navAdmin') showPage('adminPage');
    }
});

userMenuButton.addEventListener('click', () => {
    userDropdown.classList.toggle('hidden');
});

// --- NEW CANCELLATION LOGIC ---
function openConfirmModal() {
    cancelReason.value = '';
    confirmModal.classList.remove('hidden');
    setTimeout(() => confirmModal.classList.remove('opacity-0'), 10);
}

function closeConfirmModalFunc() {
    confirmModal.classList.add('opacity-0');
    setTimeout(() => confirmModal.classList.add('hidden'), 300);
}

async function handleCancelDossier() {
    const reason = cancelReason.value.trim();
    if (!reason) {
        showError("Veuillez fournir une raison pour l'annulation.");
        return;
    }

    loadingSpinner.classList.remove('hidden');

    try {
        const response = await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'cors',
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            body: JSON.stringify({
                action: 'cancelDossier',
                taskId: currentTaskId,
                userName: currentUser.name,
                reason: reason
            })
        });
        const result = await response.json();
        if (result.status !== 'success') throw new Error(result.message);

        closeConfirmModalFunc();
        closeModal();
        await fetchTasks();
        filterDataForView();
        filterAndRender();

    } catch (error) {
        showError(`Erreur lors de l'annulation: ${error.message}`);
    } finally {
        loadingSpinner.classList.add('hidden');
    }
}

cancelDossierBtn.addEventListener('click', openConfirmModal);
closeConfirmModal.addEventListener('click', closeConfirmModalFunc);
confirmCancelBtn.addEventListener('click', handleCancelDossier);
// --- END OF NEW CANCELLATION LOGIC ---

addTaskBtn.addEventListener('click', openModalForNewTask);
agentFilter.addEventListener('change', filterAndRender);
companyFilter.addEventListener('change', filterAndRender);
statusFilter.addEventListener('change', filterAndRender);
searchInput.addEventListener('input', filterAndRender);
closeModalBtn.addEventListener('click', closeModal);
saveChangesBtn.addEventListener('click', saveChanges);
importBtn.addEventListener('click', openImportModal);
closeImportModalBtn.addEventListener('click', closeImportModal);
importFile.addEventListener('change', handleFileSelect);
importConfirmBtn.addEventListener('click', processImport);

notificationBtn.addEventListener('click', () => {
    const isHidden = notificationPanel.classList.contains('hidden');
    if (isHidden) {
        notificationPanel.classList.remove('hidden');
        setTimeout(() => notificationPanel.classList.remove('opacity-0'), 10);
        markNotificationsRead();
    } else {
        notificationPanel.classList.add('opacity-0');
        setTimeout(() => notificationPanel.classList.add('hidden'), 300);
    }
});

document.getElementById('statCardTotal').addEventListener('click', () => navigateToTasksWithStatus('all'));
document.getElementById('statCardCompleted').addEventListener('click', () => navigateToTasksWithStatus('Terminé'));
document.getElementById('statCardInProgress').addEventListener('click', () => navigateToTasksWithStatus('inachevee'));
document.getElementById('statCardTodo').addEventListener('click', () => navigateToTasksWithStatus('À faire'));
document.getElementById('statCardOverdue').addEventListener('click', () => navigateToTasksWithOverdueFilter());
statCardHighDevis.addEventListener('click', navigateToTasksWithHighDevis);

tabDetails.addEventListener('click', () => switchModalTab('details'));
tabActivity.addEventListener('click', () => switchModalTab('activity'));
tabFiles.addEventListener('click', () => switchModalTab('files'));
tabComm.addEventListener('click', () => switchModalTab('comm'));
addCommentBtn.addEventListener('click', addComment);
fileUploadInput.addEventListener('change', handleFileUpload);

addAgentBtn.addEventListener('click', () => openAgentModal());
closeAgentModalBtn.addEventListener('click', closeAgentModal);
agentForm.addEventListener('submit', handleAgentFormSubmit);
agentModal.addEventListener('click', (e) => {
    if (e.target === agentModal) closeAgentModal();
});

profileButton.addEventListener('click', openProfileModal);
closeProfileModalBtn.addEventListener('click', closeProfileModal);
profileModal.addEventListener('click', (e) => {
    if (e.target === profileModal) closeProfileModal();
});
profileForm.addEventListener('submit', handleProfileFormSubmit);
changePictureBtn.addEventListener('click', () => profilePictureInput.click());
profilePictureInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
            document.getElementById('profilePicturePreview').src = event.target.result;
        }
        reader.readAsDataURL(file);
    }
});

agentsTableBody.addEventListener('click', (e) => {
    if (e.target.classList.contains('edit-agent-btn')) {
        const email = e.target.dataset.email;
        const agentToEdit = agents.find(a => a.email === email);
        if (agentToEdit) openAgentModal(agentToEdit);
    }
    if (e.target.classList.contains('delete-agent-btn')) {
        const email = e.target.dataset.email;
        if (confirm(`Êtes-vous sûr de vouloir supprimer l'agent avec l'email ${email}?`)) {
            deleteAgent(email);
        }
    }
});

taskGrid.addEventListener('click', (e) => {
    const card = e.target.closest('.task-card');
    if (card && card.dataset.taskId) {
        openModal(card.dataset.taskId);
    }
});

calendarGrid.addEventListener('click', (e) => {
    const dossierEl = e.target.closest('.calendar-task[data-task-id]');
    const advancedTaskEl = e.target.closest('.calendar-task[data-advanced-task-id]');
    const eventEl = e.target.closest('.calendar-task[data-event-id]');

    if (dossierEl) {
        openModal(dossierEl.dataset.taskId);
    } else if (advancedTaskEl) {
        const task = advancedTasks.find(t => t.ID === advancedTaskEl.dataset.advancedTaskId);
        if (task) openAdvancedTaskModal(task);
    } else if (eventEl) {
        const event = calendarEvents.find(e => e.ID === eventEl.dataset.eventId);
        if (event) openEventModal(event);
    }
});


overdueTasksList.addEventListener('click', (e) => {
    const item = e.target.closest('.overdue-item');
    if (item && item.dataset.taskId) {
        openModal(item.dataset.taskId);
    }
});

modal.addEventListener('click', (e) => {
    if (e.target.classList.contains('upload-step2-btn')) {
        e.preventDefault();
        switchModalTab('files');
        fileUploadInput.click();
    }

    const contactBtn = e.target.closest('.contact-btn');
    if (contactBtn) {
        const type = contactBtn.dataset.type;
        const target = contactBtn.dataset.target;
        logCommunication(type, target);
    }
    // ... keep the existing upload-step2-btn logic inside this listener
    if (e.target.classList.contains('upload-step2-btn')) {
        e.preventDefault();
        switchModalTab('files');
        fileUploadInput.click();
    }
});

window.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        if (!modal.classList.contains('hidden')) closeModal();
        if (!importModal.classList.contains('hidden')) closeImportModal();
        if (!notificationPanel.classList.contains('hidden')) notificationPanel.classList.add('hidden', 'opacity-0');
        if (!profileModal.classList.contains('hidden')) closeProfileModal();
        if (!agentModal.classList.contains('hidden')) closeAgentModal();
        if (!advancedTaskModal.classList.contains('hidden')) closeAdvancedTaskModal();
        if (!eventModal.classList.contains('hidden')) closeEventModal();
    }
});

document.addEventListener('click', (e) => {
    if (!notificationBtn.contains(e.target) && !notificationPanel.contains(e.target)) {
        notificationPanel.classList.add('hidden', 'opacity-0');
    }
    if (!userMenuButton.contains(e.target) && !userDropdown.contains(e.target)) {
        userDropdown.classList.add('hidden');
    }
});

modal.addEventListener('click', (e) => {
    if (e.target === modal) closeModal();
});
importModal.addEventListener('click', (e) => {
    if (e.target === importModal) closeImportModal();
});

globalSearchInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        const searchTerm = globalSearchInput.value.trim();
        if (searchTerm) {
            // Navigate to the dossiers page
            showPage('dossiersPage');
            // Set the search value on that page's specific search bar
            searchInput.value = searchTerm;
            // Trigger the search
            filterAndRender();
            // Clear the global search bar for the next use
            globalSearchInput.value = '';
            // Blur the input to hide the keyboard on mobile
            globalSearchInput.blur();
        }
    }
});

// --- EVENT LISTENERS FOR TÂCHES PAGE FILTERS ---
advancedTaskSearch.addEventListener('input', renderAdvancedTasks);
advancedTaskAssigneeFilter.addEventListener('change', renderAdvancedTasks);
advancedTaskPriorityFilter.addEventListener('change', renderAdvancedTasks);
urgentFilter.addEventListener('change', renderAdvancedTasks);


// --- THIS IS THE MISSING FUNCTION ---
function closeAdvancedTaskModal() {
    const modal = document.getElementById('advancedTaskModal');
    const content = document.getElementById('advancedTaskModalContent');
    modal.classList.add('opacity-0');
    content.classList.add('scale-95');
    setTimeout(() => {
        modal.classList.add('hidden');
    }, 300);
}


// --- UNIFIED EVENT LISTENERS FOR ADVANCED TASK MODAL (FINAL) ---

// 1. Open modal when "Ajouter une Tâche" is clicked
addAdvancedTaskBtn.addEventListener('click', () => openAdvancedTaskModal());

// 2. Listener for the 'X' close button in the corner
closeAdvancedTaskModalBtn.addEventListener('click', closeAdvancedTaskModal);

// 3. Submit the form when the "Enregistrer" button is clicked (SAVE ACTION)
advancedTaskForm.addEventListener('submit', handleAdvancedTaskFormSubmit);

// 4. Delete the task when the "Supprimer" button is clicked (DELETE ACTION)
deleteAdvancedTaskBtn.addEventListener('click', () => {
    const taskId = document.getElementById('advancedTaskId').value;
    if (taskId && confirm("Êtes-vous sûr de vouloir supprimer cette tâche?")) {
        deleteAdvancedTask(taskId);
    }
});

// 5. Single listener for all other clicks inside the modal
advancedTaskModal.addEventListener('click', (e) => {
    // A. Close the modal if the dark overlay is clicked
    if (e.target === advancedTaskModal) {
        closeAdvancedTaskModal();
    }

    // B. Add a new subtask when the "Ajouter" button is clicked
    if (e.target.closest('#addSubtaskBtn')) {
        const input = document.getElementById('newSubtaskInput');
        if (input.value.trim()) {
            const subtaskList = document.getElementById('subtaskList');
            const newIndex = subtaskList.children.length;
            
            const subtaskEl = document.createElement('div');
            subtaskEl.className = 'flex items-center justify-between bg-gray-100 p-2 rounded-md';
            subtaskEl.innerHTML = `
                <div class="flex items-center">
                    <input type="checkbox" data-index="${newIndex}" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 subtask-checkbox">
                    <label class="ml-2 text-sm text-gray-800">${input.value.trim()}</label>
                </div>
                <button type="button" data-index="${newIndex}" class="remove-subtask-btn text-gray-400 hover:text-red-600 font-bold text-lg leading-none">&times;</button>
            `;
            subtaskList.appendChild(subtaskEl);
            input.value = ''; // Clear the input
            input.focus(); // Set focus back to the input for easily adding more
        }
    }

    // C. Remove a subtask when its 'x' button is clicked
    if (e.target.classList.contains('remove-subtask-btn')) {
        // This stops the modal from opening again
        e.stopPropagation(); 
        e.target.closest('div.flex').remove();
    }

    // D. Style a subtask when its checkbox is clicked
    if (e.target.classList.contains('subtask-checkbox')) {
        const label = e.target.nextElementSibling;
        label.classList.toggle('line-through');
        label.classList.toggle('text-gray-500');
    }
});

// Add listeners for subtask functionality inside the modal

prevMonthBtn.addEventListener('click', () => {
    calendarDate.setMonth(calendarDate.getMonth() - 1);
    renderCalendar(calendarDate.getFullYear(), calendarDate.getMonth());
});
nextMonthBtn.addEventListener('click', () => {
    calendarDate.setMonth(calendarDate.getMonth() + 1);
    renderCalendar(calendarDate.getFullYear(), calendarDate.getMonth());
});
addEventBtn.addEventListener('click', () => openEventModal());
closeEventModalBtn.addEventListener('click', closeEventModal);
eventModal.addEventListener('click', (e) => {
    if (e.target === eventModal) closeEventModal();
});
eventForm.addEventListener('submit', handleEventFormSubmit);
deleteEventBtn.addEventListener('click', () => {
    const eventId = document.getElementById('eventId').value;
    if (eventId && confirm('Êtes-vous sûr de vouloir supprimer cet événement?')) {
        deleteCalendarEvent(eventId);
    }
});
calendarAgentFilter.addEventListener('change', () => {
    renderCalendar(calendarDate.getFullYear(), calendarDate.getMonth());
});

// Helper to populate the new dropdown when the page is shown
function populateCalendarAgentFilter() {
    calendarAgentFilter.innerHTML = '<option value="all">Tous les agents</option>';
    agents.forEach(agent => {
        if (agent.name) { // Ensure agent has a name
            calendarAgentFilter.appendChild(new Option(agent.name, agent.name));
        }
    });
}


productivityDateInput.addEventListener('change', renderProductivityPage);

// --- NEW: PRODUCTIVITY DROPDOWN LOGIC ---
productivityTableBody.addEventListener('click', (e) => {
    const toggleBtn = e.target.closest('.toggle-details-btn');
    if (toggleBtn) {
        const targetId = toggleBtn.dataset.targetId;
        const detailsRow = document.getElementById(targetId);
        const icon = toggleBtn.querySelector('svg');
        if (detailsRow) {
            detailsRow.classList.toggle('hidden');
            icon.classList.toggle('rotate-90');
        }
    }

    const dossierItem = e.target.closest('.dossier-list-item');
    if (dossierItem) {
        openModal(dossierItem.dataset.taskId);
    }
});


// NEW: Stats page listeners
statsWeeklyBtn.addEventListener('click', () => renderStatsPage('weekly'));
statsMonthlyBtn.addEventListener('click', () => renderStatsPage('monthly'));
statsQuarterlyBtn.addEventListener('click', () => renderStatsPage('quarterly'));

// --- FACTURATION PAGE EVENT LISTENERS ---
document.querySelector('#facturationPage').addEventListener('click', (e) => {
    // Handle tab clicks
    const tab = e.target.closest('.facturation-tab');
    if (tab) {
        document.querySelectorAll('.facturation-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        renderFacturationPage(tab.dataset.filter);
    }

    // Handle table row clicks
    const row = e.target.closest('tr[data-task-id]');
    if (row) {
        openModal(row.dataset.taskId);
    }
    const paymentBtn = e.target.closest('.validate-payment-btn');
    if (paymentBtn) {
        const taskId = paymentBtn.dataset.taskId;
        validatePayment(taskId);
    }
});

async function validatePayment(taskId) {
    if (!confirm("Êtes-vous sûr de vouloir marquer ce dossier comme payé? Cette action est irréversible.")) {
        return;
    }
    loadingSpinner.classList.remove('hidden');
    try {
        const response = await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'cors',
            headers: {
                'Content-Type': 'text/plain;charset=utf-8'
            },
            body: JSON.stringify({
                action: 'markAsPaid',
                id: taskId,
                userName: currentUser.name
            })
        });
        const result = await response.json();
        if (result.status !== 'success') throw new Error(result.message);

        await fetchTasks();
        renderFacturationPage(document.querySelector('.facturation-tab.active').dataset.filter);

    } catch (error) {
        showError(`Erreur: ${error.message}`);
    } finally {
        loadingSpinner.classList.add('hidden');
    }
}


// --- INITIALIZATION ---
function initializeApp() {
    if (APPS_SCRIPT_URL === 'YOUR_DEPLOYED_WEB_APP_URL_HERE' || !APPS_SCRIPT_URL) {
        loadingSpinner.classList.add('hidden');
        showError("Configuration requise: Veuillez coller l'URL de votre application Web Google Apps Script dans la variable APPS_SCRIPT_URL.");
        loginButton.disabled = true;
        return;
    }
    setupDragAndDrop();

    productivityDateInput.value = new Date().toISOString().split('T')[0];

    const savedUser = localStorage.getItem('currentUser');
    if (savedUser) {
        currentUser = JSON.parse(savedUser);
        initializeAppState();
    } else {
        initializeLogin();
    }
}

document.addEventListener('DOMContentLoaded', initializeApp);

    </script>
</body>
</html>